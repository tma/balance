<% content_for :title, "#{@position.symbol} - #{@connection.name}" %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Settings" %>
    <%= ui_breadcrumb_item "Brokers", admin_broker_connections_path %>
    <%= ui_breadcrumb_item @connection.name, admin_broker_connection_path(@connection) %>
  <% end %>
<% end %>

<div class="w-full">
  <div class="flex justify-between items-center h-10 mb-6">
    <div>
      <h1 class="<%= ui_title_class %>">
        <%= @position.symbol %>
        <% if @position.closed? %>
          <span class="<%= ui_badge_class %> ml-2">Closed</span>
        <% end %>
      </h1>
      <p class="text-sm <%= ui_text_muted_class %>"><%= @position.description %></p>
    </div>
    <div class="flex items-center space-x-4">
      <% if @position.closed? %>
        <span class="<%= ui_badge_class %>">
          Closed <%= @position.closed_at&.strftime("%Y-%m-%d") %>
        </span>
      <% elsif @position.mapped? %>
        <span class="<%= ui_badge_success_class %>">
          Mapped to <%= @position.asset.name %>
        </span>
      <% else %>
        <span class="<%= ui_badge_warning_class %>">
          Unmapped
        </span>
      <% end %>
    </div>
  </div>

  <!-- Current Position -->
  <div class="grid grid-cols-3 gap-4 mb-6">
    <div class="<%= ui_card_class %> p-4">
      <p class="text-xs font-medium <%= ui_text_muted_class %> uppercase">Quantity</p>
      <p class="text-2xl font-bold <%= ui_text_class %> mt-1">
        <%= number_with_delimiter(@position.last_quantity) if @position.last_quantity %>
      </p>
    </div>
    <div class="<%= ui_card_class %> p-4">
      <p class="text-xs font-medium <%= ui_text_muted_class %> uppercase">Value</p>
      <p class="text-2xl font-bold <%= ui_text_class %> mt-1">
        <%= format_currency(@position.last_value, currency: @position.currency) if @position.last_value %>
      </p>
    </div>
    <div class="<%= ui_card_class %> p-4">
      <p class="text-xs font-medium <%= ui_text_muted_class %> uppercase">Last Synced</p>
      <p class="text-lg font-medium <%= ui_text_class %> mt-1">
        <% if @position.last_synced_at %>
          <%= @position.last_synced_at.strftime("%Y-%m-%d %H:%M") %>
        <% else %>
          Never
        <% end %>
      </p>
    </div>
  </div>

  <!-- Valuation History -->
  <% default_currency = Currency.default&.code || "USD" %>
  <% show_default_currency = @position.currency != default_currency %>
  
  <div class="<%= ui_card_class %> overflow-hidden">
    <div class="<%= ui_table_header_class %> px-4 py-2">
      <h2 class="font-semibold <%= ui_text_class %>">Valuation History</h2>
      <p class="text-xs <%= ui_text_muted_class %> mt-1">Daily snapshots of position value (last 90 days)</p>
    </div>

    <% if @valuations.any? %>
      <table class="min-w-full">
        <thead class="<%= ui_table_header_class %>">
          <tr>
            <th class="<%= ui_table_th_class %> text-left">Date</th>
            <th class="<%= ui_table_th_class %> text-right">Quantity</th>
            <th class="<%= ui_table_th_class %> text-right">Value (<%= @position.currency %>)</th>
            <% if show_default_currency %>
              <th class="<%= ui_table_th_class %> text-right">Value (<%= default_currency %>)</th>
            <% end %>
            <th class="<%= ui_table_th_class %> text-right">Change</th>
            <th class="<%= ui_table_th_class %> text-right w-20"></th>
          </tr>
        </thead>
        <tbody>
          <% previous_value = nil %>
          <% @valuations.each do |valuation| %>
            <tr class="<%= ui_table_row_class %>" data-controller="inline-save">
              <td class="<%= ui_table_td_class %> whitespace-nowrap">
                <span class="font-medium <%= ui_text_class %>"><%= valuation.date.strftime("%Y-%m-%d") %></span>
                <span class="text-xs <%= ui_text_subtle_class %> ml-2"><%= valuation.date.strftime("%a") %></span>
              </td>
              <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                <input type="text" name="position_valuation[quantity]" value="<%= valuation.quantity %>" form="valuation-form-<%= valuation.id %>" class="<%= ui_input_sm_class %> w-24 text-right" data-inline-save-target="input" data-action="input->inline-save#check">
              </td>
              <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                <input type="text" name="position_valuation[value]" value="<%= valuation.value %>" form="valuation-form-<%= valuation.id %>" class="<%= ui_input_sm_class %> w-32 text-right" data-controller="currency-input" data-currency-input-original-value="<%= valuation.value %>" data-inline-save-target="input" data-action="input->inline-save#check focus->currency-input#unformat blur->currency-input#format">
              </td>
              <% if show_default_currency %>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <span class="<%= ui_text_muted_class %>">
                    <% if valuation.value_in_default_currency %>
                      <%= format_currency(valuation.value_in_default_currency, currency: default_currency) %>
                      <% if valuation.exchange_rate && valuation.exchange_rate != 1.0 %>
                        <span class="text-xs <%= ui_text_subtle_class %> block">@ <%= number_with_precision(valuation.exchange_rate, precision: 4) %></span>
                      <% end %>
                    <% else %>
                      <span class="<%= ui_text_subtle_class %>">—</span>
                    <% end %>
                  </span>
                </td>
              <% end %>
              <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                <% if previous_value %>
                  <% change = valuation.value - previous_value %>
                  <% change_percent = previous_value != 0 ? (change / previous_value * 100) : 0 %>
                  <span class="<%= change >= 0 ? ui_positive_class : ui_negative_class %>">
                    <%= change >= 0 ? '+' : '' %><%= format_amount(change) %>
                    <span class="text-xs">(<%= change >= 0 ? '+' : '' %><%= number_to_percentage(change_percent, precision: 1) %>)</span>
                  </span>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">—</span>
                <% end %>
                <% previous_value = valuation.value %>
              </td>
              <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                <div class="flex items-center justify-end gap-2">
                  <form id="valuation-form-<%= valuation.id %>" action="<%= admin_broker_connection_position_valuation_path(@connection, @position, valuation) %>" method="post" class="inline" data-action="submit->inline-save#unformatAll">
                    <input type="hidden" name="_method" value="patch">
                    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                    <button type="submit" class="<%= ui_text_subtle_class %>" disabled data-inline-save-target="save">Save</button>
                  </form>
                  <%= button_to "Delete", admin_broker_connection_position_valuation_path(@connection, @position, valuation), 
                        method: :delete, 
                        class: "text-rose-500 hover:text-rose-600 dark:text-rose-400 dark:hover:text-rose-300",
                        form: { data: { turbo_confirm: "Delete valuation for #{valuation.date.strftime('%Y-%m-%d')}?" } } %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="<%= ui_empty_class %>">
        <p class="<%= ui_text_muted_class %> mb-2">No valuation history yet.</p>
        <p class="text-sm <%= ui_text_subtle_class %>">Valuations are recorded daily or when you sync.</p>
      </div>
    <% end %>
  </div>
</div>
