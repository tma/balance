<% content_for :title, "#{@connection.name} - #{@connection.broker_type_name}" %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Settings" %>
    <%= ui_breadcrumb_item "Brokers", admin_broker_connections_path %>
  <% end %>
<% end %>

<div class="w-full">
  <div class="flex justify-between items-center h-10 mb-6">
    <div>
      <h1 class="<%= ui_title_class %>"><%= @connection.name %></h1>
      <div class="flex items-center gap-2 text-sm">
        <span class="<%= ui_text_muted_class %>"><%= @connection.broker_type_name %> · Account: <%= @connection.account_id %></span>
        <span class="<%= ui_text_subtle_class %>">·</span>
        <span class="<%= ui_badge_class %>"><span>Open:</span> <span class="font-semibold"><%= @positions.open.count %></span></span>
        <span class="<%= ui_badge_success_class %>"><span>Mapped:</span> <span class="font-semibold"><%= @connection.mapped_positions.open.count %></span></span>
        <span class="<%= @connection.unmapped_positions.open.any? ? ui_badge_warning_class : ui_badge_class %>"><span>Unmapped:</span> <span class="font-semibold"><%= @connection.unmapped_positions.open.count %></span></span>
        <span class="<%= ui_badge_class %>"><span>Closed:</span> <span class="font-semibold"><%= @positions.closed.count %></span></span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <%= button_to "Sync Now", sync_admin_broker_connection_path(@connection), method: :post, form: { data: { turbo_confirm: "This will sync positions from the broker. Continue?" } }, class: ui_btn_secondary_class %>
      <%= link_to "Edit", edit_admin_broker_connection_path(@connection), class: ui_btn_secondary_class %>
    </div>
  </div>

  <% if @connection.last_sync_error.present? %>
    <div class="<%= ui_alert_error_class %> mb-6">
      <p class="font-medium">Last sync failed</p>
      <p class="text-sm mt-1"><%= @connection.last_sync_error %></p>
    </div>
  <% elsif @connection.sync_status == :behind %>
    <div class="<%= ui_alert_warning_class %> mb-6">
      <p class="font-medium">Sync is <%= @connection.missing_sync_days %> days behind</p>
      <p class="text-sm mt-1">Missing days in the last 14 days will be backfilled on the next sync.</p>
    </div>
  <% end %>

  <div class="<%= ui_card_class %> overflow-hidden">
    <div class="<%= ui_table_header_class %> px-4 py-2 flex justify-between items-center">
      <h2 class="font-semibold <%= ui_text_class %>">Positions</h2>
      <% if @connection.last_synced_at %>
        <span class="text-xs <%= ui_text_muted_class %>">
          Last synced: <%= @connection.last_synced_at.strftime("%Y-%m-%d %H:%M") %>
        </span>
      <% end %>
    </div>

    <% if @positions.any? %>
      <%= form_with url: bulk_update_admin_broker_connection_positions_path(@connection), method: :patch, class: "contents" do |form| %>
        <table class="min-w-full">
          <thead class="<%= ui_table_header_class %>">
            <tr>
              <th class="<%= ui_table_th_class %> text-left">Symbol</th>
              <th class="<%= ui_table_th_class %> text-left">Description</th>
              <th class="<%= ui_table_th_class %> text-right">Quantity</th>
              <th class="<%= ui_table_th_class %> text-right">Value</th>
              <th class="<%= ui_table_th_class %> text-left min-w-[200px]">Mapped Asset</th>
            </tr>
          </thead>
          <tbody>
            <% @positions.open.each do |position| %>
              <tr class="<%= ui_table_row_class %>">
                <td class="<%= ui_table_td_class %> whitespace-nowrap">
                  <%= link_to admin_broker_connection_position_path(@connection, position), class: "font-medium #{ui_link_class}" do %>
                    <%= position.symbol %>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %>">
                  <span class="<%= ui_text_muted_class %>"><%= position.description || "—" %></span>
                </td>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <span class="<%= ui_text_muted_class %>"><%= number_with_delimiter(position.last_quantity) if position.last_quantity %></span>
                </td>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <% if position.last_value %>
                    <span class="font-medium <%= ui_text_class %>">
                      <%= format_currency(position.last_value_in_default_currency || position.last_value, currency: @default_currency) %>
                    </span>
                    <% if position.currency != @default_currency %>
                      <p class="text-xs <%= ui_text_subtle_class %>"><%= format_currency(position.last_value, currency: position.currency) %></p>
                    <% end %>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %>">
                  <select name="positions[<%= position.id %>]" class="<%= ui_input_sm_class %> w-full">
                    <option value="">— Not mapped —</option>
                    <% @asset_groups.each do |group| %>
                      <optgroup label="<%= group.name %>">
                        <% group.assets.sort_by(&:name).each do |asset| %>
                          <option value="<%= asset.id %>" <%= 'selected' if position.asset_id == asset.id %>>
                            <%= asset.name %>
                          </option>
                        <% end %>
                      </optgroup>
                    <% end %>
                  </select>
                </td>
              </tr>
            <% end %>
            <% if @positions.closed.any? %>
              <tr class="<%= ui_table_group_header_class %> border-t border-b border-slate-200 dark:border-slate-600">
                <td colspan="5" class="px-4 py-2 text-xs font-medium <%= ui_table_group_text_class %> uppercase">Closed Positions</td>
              </tr>
              <% @positions.closed.each do |position| %>
                <tr class="<%= ui_table_row_class %> opacity-60">
                  <td class="<%= ui_table_td_class %> whitespace-nowrap">
                    <%= link_to admin_broker_connection_position_path(@connection, position), class: "font-medium #{ui_link_muted_class}" do %>
                      <%= position.symbol %>
                      <span class="<%= ui_badge_class %> ml-1">Closed</span>
                    <% end %>
                  </td>
                  <td class="<%= ui_table_td_class %>">
                    <span class="<%= ui_text_muted_class %>"><%= position.description || "—" %></span>
                  </td>
                  <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                    <span class="<%= ui_text_subtle_class %>">0</span>
                  </td>
                  <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                    <span class="<%= ui_text_subtle_class %>">
                      <%= format_currency(0, currency: @default_currency) %>
                    </span>
                  </td>
                  <td class="<%= ui_table_td_class %>">
                    <span class="text-xs <%= ui_text_subtle_class %>">Closed <%= position.closed_at&.strftime("%Y-%m-%d") %></span>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
        <div class="<%= ui_table_header_class %> px-4 py-2 flex justify-end">
          <%= form.submit "Save Mappings", class: ui_btn_primary_class + " cursor-pointer" %>
        </div>
      <% end %>
    <% else %>
      <div class="<%= ui_empty_class %>">
        <p class="<%= ui_text_muted_class %> mb-2">No positions found.</p>
        <p class="text-sm <%= ui_text_subtle_class %>">Positions sync automatically daily.</p>
      </div>
    <% end %>
  </div>
</div>
