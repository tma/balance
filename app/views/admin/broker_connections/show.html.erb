<% content_for :title, "#{@connection.name} - #{@connection.broker_type_name}" %>

<div class="w-full">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-slate-800"><%= @connection.name %></h1>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-500"><%= @connection.broker_type_name %> · Account: <%= @connection.account_id %></span>
        <span class="text-slate-300">·</span>
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 text-slate-600"><span>Open:</span> <span class="font-semibold"><%= @positions.open.count %></span></span>
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700"><span>Mapped:</span> <span class="font-semibold"><%= @connection.mapped_positions.open.count %></span></span>
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full <%= @connection.unmapped_positions.open.any? ? 'bg-amber-50 text-amber-700' : 'bg-slate-50 text-slate-400' %>"><span>Unmapped:</span> <span class="font-semibold"><%= @connection.unmapped_positions.open.count %></span></span>
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-50 text-slate-400"><span>Closed:</span> <span class="font-semibold"><%= @positions.closed.count %></span></span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <%= button_to "Sync Now", sync_admin_broker_connection_path(@connection), method: :post, form: { data: { turbo_confirm: "This will sync positions from the broker. Continue?" } }, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
      <%= link_to "Edit", edit_admin_broker_connection_path(@connection), class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
    </div>
  </div>

  <% if @connection.last_sync_error.present? %>
    <div class="bg-rose-50 border border-rose-200 text-rose-700 px-4 py-3 rounded-lg mb-6">
      <p class="font-medium">Last sync failed</p>
      <p class="text-sm mt-1"><%= @connection.last_sync_error %></p>
    </div>
  <% elsif @connection.sync_status == :behind %>
    <div class="bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-lg mb-6">
      <p class="font-medium">Sync is <%= @connection.days_behind %> days behind</p>
      <p class="text-sm mt-1">Last synced data is from <%= @connection.last_sync_date&.strftime("%B %-d, %Y") %>. Missing days will be backfilled on the next sync.</p>
    </div>
  <% end %>

  <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
      <h2 class="font-semibold text-slate-700">Positions</h2>
      <% if @connection.last_synced_at %>
        <span class="text-xs text-slate-500">
          Last synced: <%= @connection.last_synced_at.strftime("%Y-%m-%d %H:%M") %>
          <% if @connection.last_sync_date %>
            (data as of <%= @connection.last_sync_date.strftime("%b %-d") %>)
          <% end %>
        </span>
      <% end %>
    </div>

    <% if @positions.any? %>
      <%= form_with url: bulk_update_admin_broker_connection_positions_path(@connection), method: :patch, class: "contents" do |form| %>
        <table class="min-w-full">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Symbol</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Quantity</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Value</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider min-w-[200px]">Mapped Asset</th>
            </tr>
          </thead>
          <tbody class="bg-white">
            <% @positions.open.each do |position| %>
              <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-b-0">
                <td class="px-4 py-3 whitespace-nowrap">
                  <%= link_to admin_broker_connection_position_path(@connection, position), class: "text-sm font-medium text-cyan-600 hover:text-cyan-700" do %>
                    <%= position.symbol %>
                  <% end %>
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm text-slate-600"><%= position.description || "—" %></span>
                </td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                  <span class="text-sm text-slate-600"><%= number_with_delimiter(position.last_quantity) if position.last_quantity %></span>
                </td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                  <span class="text-sm font-medium text-slate-700">
                    <% if position.last_value %>
                      <%= format_currency(position.last_value, currency: position.currency) %>
                    <% end %>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <select name="positions[<%= position.id %>]" class="w-full rounded-lg border-slate-300 text-sm focus:border-cyan-500 focus:ring-cyan-500">
                    <option value="">— Not mapped —</option>
                    <% @asset_groups.each do |group| %>
                      <optgroup label="<%= group.name %>">
                        <% group.assets.sort_by(&:name).each do |asset| %>
                          <option value="<%= asset.id %>" <%= 'selected' if position.asset_id == asset.id %>>
                            <%= asset.name %>
                          </option>
                        <% end %>
                      </optgroup>
                    <% end %>
                  </select>
                </td>
              </tr>
            <% end %>
            <% if @positions.closed.any? %>
              <tr class="bg-slate-50">
                <td colspan="5" class="px-4 py-2 text-xs font-medium text-slate-500 uppercase">Closed Positions</td>
              </tr>
              <% @positions.closed.each do |position| %>
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-b-0 opacity-60">
                  <td class="px-4 py-3 whitespace-nowrap">
                    <%= link_to admin_broker_connection_position_path(@connection, position), class: "text-sm font-medium text-slate-500 hover:text-slate-700" do %>
                      <%= position.symbol %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-slate-200 text-slate-600 ml-1">Closed</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3">
                    <span class="text-sm text-slate-500"><%= position.description || "—" %></span>
                  </td>
                  <td class="px-4 py-3 text-right whitespace-nowrap">
                    <span class="text-sm text-slate-400">0</span>
                  </td>
                  <td class="px-4 py-3 text-right whitespace-nowrap">
                    <span class="text-sm text-slate-400">
                      <%= format_currency(0, currency: position.currency) %>
                    </span>
                  </td>
                  <td class="px-4 py-3">
                    <span class="text-xs text-slate-400">Closed <%= position.closed_at&.strftime("%Y-%m-%d") %></span>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
        <div class="px-4 py-3 border-t border-slate-200 bg-slate-50 flex justify-end">
          <%= form.submit "Save Mappings", class: "rounded-lg px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-medium cursor-pointer transition" %>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-8">
        <p class="text-slate-500 mb-2">No positions found.</p>
        <p class="text-sm text-slate-400">Positions sync automatically daily.</p>
      </div>
    <% end %>
  </div>

  <div class="mt-6">
    <%= link_to "← Back to Connections", admin_broker_connections_path, class: "text-cyan-600 hover:text-cyan-700 text-sm" %>
  </div>
</div>
