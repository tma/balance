<div class="space-y-6">
  <%
    # Calculate totals for chart using selected month's valuations
    # Uses net values (assets - liabilities) per group
    # Includes both active assets and archived assets with valuations for the selected month
    default_colors = %w[#60a5fa #4ade80 #f87171 #a78bfa #fb923c #22d3ee #e879f9 #facc15 #94a3b8 #2dd4bf]

    # Build group data using net values from controller
    group_data = []
    @asset_groups.each_with_index do |group, idx|
      net_value = @group_totals[group.id] || 0
      next if net_value == 0
      group_data << {
        name: group.name,
        value: net_value,
        pct: 0, # calculated below
        color: group.color || default_colors[idx % default_colors.length],
      }
    end

    # Calculate percentages based on net values
    total_net = group_data.sum { |g| g[:value] }
    group_data.each do |g|
      g[:pct] = total_net > 0 ? (g[:value].to_f / total_net * 100).round(1) : 0
    end
  %>

  <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
    <div>
      <div class="flex items-center space-x-4 mb-2">
        <%= link_to net_worth_path(month: (@valuation_date - 1.month).strftime("%Y-%m")), class: "text-slate-400 hover:text-slate-600" do %>
          ← <%= (@valuation_date - 1.month).strftime("%b %Y") %>
        <% end %>
        <h1 class="text-lg font-semibold text-slate-700"><%= @valuation_date.strftime("%B %Y") %></h1>
        <% if @valuation_date.end_of_month < Date.current.end_of_month %>
          <%= link_to net_worth_path(month: (@valuation_date + 1.month).strftime("%Y-%m")), class: "text-slate-400 hover:text-slate-600" do %>
            <%= (@valuation_date + 1.month).strftime("%b %Y") %> →
          <% end %>
        <% else %>
          <span class="text-slate-300">Now →</span>
        <% end %>
      </div>
      <p class="text-4xl font-bold text-slate-800"><%= format_currency(@net_worth[:net_worth], precision: 0) %></p>
      <% if @net_worth_change != 0 %>
        <p class="text-sm mt-1 <%= @net_worth_change >= 0 ? 'text-emerald-600' : 'text-rose-500' %>">
          <%= @net_worth_change >= 0 ? '+' : '' %><%= format_currency(@net_worth_change, precision: 0) %> from last month
        </p>
      <% end %>
    </div>
    
    <% if group_data.any? %>
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <svg class="w-24 h-24 sm:w-[100px] sm:h-[100px] flex-shrink-0" viewBox="0 0 160 160">
          <% offset = 0 %>
          <% group_data.each do |group| %>
            <% arc_length = (group[:pct] * 3.77).round(2) %>
            <circle cx="80" cy="80" r="60" fill="none" 
                    stroke="<%= group[:color] %>" stroke-width="35"
                    stroke-dasharray="<%= arc_length %> 377"
                    stroke-dashoffset="<%= -offset %>"
                    transform="rotate(-90 80 80)" />
            <% offset += arc_length %>
          <% end %>
        </svg>
        
        <div class="space-y-1 sm:space-y-2">
          <% group_data.each do |group| %>
            <div class="flex items-center gap-2 sm:gap-3">
              <svg class="flex-shrink-0" width="12" height="12"><rect width="12" height="12" fill="<%= group[:color] %>"/></svg>
              <span class="text-xs sm:text-sm text-slate-600 truncate max-w-[80px] sm:max-w-[128px]"><%= group[:name] %></span>
              <span class="text-xs sm:text-sm text-slate-700 whitespace-nowrap ml-auto"><%= format_currency(group[:value], precision: 0) %></span>
              <span class="text-xs sm:text-sm text-slate-400 whitespace-nowrap w-10 sm:w-12 text-right"><%= group[:pct] %>%</span>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <%= link_to "Cash Flow", cash_flow_path, class: "text-cyan-600 hover:text-cyan-700 hover:underline" %>
    <% end %>
  </div>

  <!-- Net Worth Summary -->
  <% if @net_worth[:net_worth] == 0 && @net_worth[:cash] == 0 && @net_worth[:assets] == 0 %>
    <div class="bg-white rounded-xl border border-slate-200 p-6">
      <p class="text-slate-500">No financial data yet. Add accounts or assets to get started.</p>
    </div>
  <% end %>

  <!-- History Bar Charts -->
  <% if @asset_groups.any? { |g| g.assets.any? } %>
    <%
      chart_height = 150
      
      max_value = @history_months.map { |m| 
        @asset_groups.sum { |g| [@history_by_group[g.id][m] || 0, 0].max }
      }.max || 1
      
      max_value_q = @history_quarters.map { |q| 
        @asset_groups.sum { |g| [@history_by_group_quarterly[g.id][q] || 0, 0].max }
      }.max || 1
    %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Monthly Chart -->
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <h2 class="text-sm font-semibold text-slate-800 mb-3">Monthly</h2>
        <div class="w-full px-2">
          <svg class="w-full" height="<%= chart_height %>" viewBox="0 0 100 <%= chart_height %>" preserveAspectRatio="none">
            <% bar_pct = 7 %>
            <% gap_pct = 1.33 %>
            <% start_offset = (gap_pct / 2) %>
            <% @history_months.each_with_index do |month, month_idx| %>
              <% x_pct = start_offset + month_idx * (bar_pct + gap_pct) %>
              <% y_offset = 0 %>
              <% month_total = @asset_groups.sum { |g| @history_by_group[g.id][month] || 0 } %>
              
              <% @asset_groups.to_a.reverse.each do |group| %>
                <% value = @history_by_group[group.id][month] || 0 %>
                <% next if value <= 0 %>
                <% bar_height = (value.to_f / max_value * chart_height).round %>
                <% y = chart_height - y_offset - bar_height %>
                <% pct = month_total > 0 ? (value.to_f / month_total * 100).round(1) : 0 %>
                
                <rect x="<%= x_pct %>%" y="<%= y %>" width="<%= bar_pct %>%" height="<%= bar_height %>"
                      fill="<%= group.color || '#94a3b8' %>">
                  <title><%= group.name %>: <%= number_to_currency(value, precision: 0, unit: @default_currency + ' ', format: '%u%n', delimiter: "'") %> (<%= pct %>%)</title>
                </rect>
                
                <% y_offset += bar_height %>
              <% end %>
            <% end %>
          </svg>
          <div class="flex" style="font-size: 9px;">
            <% @history_months.each_with_index do |month, month_idx| %>
              <div style="width: <%= bar_pct + gap_pct %>%; text-align: center;">
                <div class="text-slate-500"><%= month.strftime("%b")[0] %></div>
                <% if month.month == 1 || month_idx == 0 %>
                  <div class="text-slate-400"><%= month.strftime("%y") %></div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Quarterly Chart -->
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <h2 class="text-sm font-semibold text-slate-800 mb-3">Quarterly</h2>
        <div class="w-full px-2">
          <svg class="w-full" height="<%= chart_height %>" viewBox="0 0 100 <%= chart_height %>" preserveAspectRatio="none">
            <% bar_pct = 7 %>
            <% gap_pct = 1.33 %>
            <% start_offset = (gap_pct / 2) %>
            <% @history_quarters.each_with_index do |quarter, q_idx| %>
              <% x_pct = start_offset + q_idx * (bar_pct + gap_pct) %>
              <% y_offset = 0 %>
              <% quarter_total = @asset_groups.sum { |g| @history_by_group_quarterly[g.id][quarter] || 0 } %>
              
              <% @asset_groups.to_a.reverse.each do |group| %>
                <% value = @history_by_group_quarterly[group.id][quarter] || 0 %>
                <% next if value <= 0 %>
                <% bar_height = (value.to_f / max_value_q * chart_height).round %>
                <% y = chart_height - y_offset - bar_height %>
                <% pct = quarter_total > 0 ? (value.to_f / quarter_total * 100).round(1) : 0 %>
                
                <rect x="<%= x_pct %>%" y="<%= y %>" width="<%= bar_pct %>%" height="<%= bar_height %>"
                      fill="<%= group.color || '#94a3b8' %>">
                  <title><%= group.name %>: <%= number_to_currency(value, precision: 0, unit: @default_currency + ' ', format: '%u%n', delimiter: "'") %> (<%= pct %>%)</title>
                </rect>
                
                <% y_offset += bar_height %>
              <% end %>
            <% end %>
          </svg>
          <div class="flex" style="font-size: 9px;">
            <% @history_quarters.each_with_index do |quarter, q_idx| %>
              <div style="width: <%= bar_pct + gap_pct %>%; text-align: center;">
                <div class="text-slate-500">Q<%= ((quarter.month - 1) / 3) + 1 %></div>
                <% if quarter.month <= 3 || q_idx == 0 %>
                  <div class="text-slate-400"><%= quarter.strftime("%y") %></div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Asset Groups Breakdown -->
  <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
      <h2 class="text-lg font-semibold text-slate-800">Assets</h2>
      <%= link_to "Update Values", update_valuations_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-medium transition text-sm" %>
    </div>

    <% 
      # Check if any group has assets to show (active or archived with valuations)
      has_assets_to_show = @asset_groups.any? do |group|
        group.assets.active.any? || group.assets.archived.any? { |a| @valuations_by_asset[a.id].present? }
      end
    %>
    <% if !has_assets_to_show %>
      <div class="p-6 text-center">
        <p class="text-slate-500 mb-4">No assets yet.</p>
        <%= link_to "Add an asset", new_asset_path, class: "text-cyan-600 hover:underline" %>
      </div>
    <% else %>
      <table class="w-full">
        <tbody>
          <% @asset_groups.each_with_index do |group, group_index| %>
            <% active_assets = group.assets.active.includes(:asset_type).order(:position, :name) %>
            <% archived_with_valuations = group.assets.archived.includes(:asset_type).order(:position, :name).select { |a| @valuations_by_asset[a.id].present? } %>
            <% next if active_assets.empty? && archived_with_valuations.empty? %>

            <tr class="bg-slate-200 <%= group_index > 0 ? 'border-t-4 border-slate-300' : '' %>">
              <td class="px-4 py-2">
                <span class="inline-flex items-center">
                  <svg class="flex-shrink-0 mr-2" width="16" height="16"><rect width="16" height="16" fill="<%= group.color || '#94a3b8' %>"/></svg>
                  <span class="font-semibold text-slate-700 whitespace-nowrap"><%= group.name %></span>
                </span>
              </td>
              <td></td>
            </tr>

            <%# Active assets %>
            <% active_assets.each do |asset| %>
              <% valuation = @valuations_by_asset[asset.id] %>
              <tr class="hover:bg-slate-50 transition border-t border-slate-100">
                <td class="px-4 py-3">
                  <%= link_to asset, class: "block" do %>
                    <p class="text-sm font-medium text-slate-700 hover:text-cyan-600 whitespace-nowrap">
                      <%= asset.name %>
                      <% if @broker_asset_ids.include?(asset.id) %>
                        <span class="ml-1 px-1.5 py-0.5 text-xs rounded bg-cyan-50 text-cyan-600">Broker</span>
                      <% end %>
                    </p>
                    <p class="text-xs text-slate-400 whitespace-nowrap">
                      <%= asset.asset_type.name %> · <%= asset.currency %><% if asset.asset_type.is_liability %> <span class="ml-1 px-1.5 py-0.5 text-xs rounded bg-rose-100 text-rose-600">Liability</span><% end %>
                    </p>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                  <% if valuation %>
                    <span class="text-sm text-slate-700">
                      <%= asset.asset_type.is_liability ? '-' : '' %><%= format_currency(valuation.value_in_default_currency || 0, precision: 0) %>
                    </span>
                    <% if asset.currency != @default_currency %>
                      <p class="text-xs text-slate-400"><%= asset.currency %> <%= format_amount(valuation.value) %></p>
                    <% end %>
                  <% else %>
                    <span class="text-sm text-slate-300">—</span>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <%# Archived assets with valuations - shown inline with label %>
            <% archived_with_valuations.each do |asset| %>
              <% valuation = @valuations_by_asset[asset.id] %>
              <tr class="hover:bg-slate-50 transition border-t border-slate-100">
                <td class="px-4 py-3">
                  <%= link_to asset, class: "block" do %>
                    <p class="text-sm font-medium text-slate-400 hover:text-cyan-600 whitespace-nowrap">
                      <%= asset.name %>
                      <span class="ml-1 px-1.5 py-0.5 text-xs rounded bg-slate-100 text-slate-400">Archived</span>
                    </p>
                    <p class="text-xs text-slate-300 whitespace-nowrap">
                      <%= asset.asset_type.name %> · <%= asset.currency %><% if asset.asset_type.is_liability %> <span class="ml-1 px-1.5 py-0.5 text-xs rounded bg-rose-100 text-rose-400">Liability</span><% end %>
                    </p>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                  <span class="text-sm text-slate-400">
                    <%= asset.asset_type.is_liability ? '-' : '' %><%= format_currency(valuation.value_in_default_currency || 0, precision: 0) %>
                  </span>
                  <% if asset.currency != @default_currency %>
                    <p class="text-xs text-slate-300"><%= asset.currency %> <%= format_amount(valuation.value) %></p>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <tr class="bg-slate-50 border-t border-slate-200">
              <td class="px-4 py-2"></td>
              <td class="px-4 py-2 text-right">
                <% net_value = @group_totals[group.id] %>
                <% if net_value && net_value != 0 %>
                  <span class="font-semibold text-sm whitespace-nowrap text-slate-600"><%= format_currency(net_value, precision: 0) %></span>
                <% end %>
              </td>
            </tr>
          <% end %>

          <tr class="bg-slate-200 border-t-4 border-slate-300">
            <td class="px-4 py-3">
              <span class="font-bold text-slate-800 whitespace-nowrap">Total Net Worth</span>
            </td>
            <td class="px-4 py-3 text-right">
              <span class="font-bold text-sm whitespace-nowrap text-slate-700"><%= format_currency(@totals[:net], precision: 0) %></span>
            </td>
          </tr>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
