<div class="space-y-6">
  <%
    # Calculate totals for chart
    total_abs = @asset_groups.sum { |g| g.assets.sum { |a| a.value_in_default_currency&.abs || 0 } }
    group_colors = [
      '#60a5fa', # blue-400
      '#4ade80', # green-400
      '#f87171', # red-400
      '#a78bfa', # violet-400
      '#fb923c', # orange-400
      '#22d3ee', # cyan-400
      '#e879f9', # fuchsia-400
      '#facc15', # yellow-400
      '#94a3b8', # slate-400
      '#2dd4bf', # teal-400
    ]
    
    # Build group data
    group_data = []
    @asset_groups.each_with_index do |group, idx|
      next if group.assets.empty?
      group_total = group.assets.sum { |a| a.value_in_default_currency&.abs || 0 }
      next if group_total == 0
      group_data << {
        name: group.name,
        value: group_total,
        pct: total_abs > 0 ? (group_total.to_f / total_abs * 100).round(1) : 0,
        color: group_colors[idx % group_colors.length],
      }
    end
  %>

  <div class="flex justify-between items-start">
    <div>
      <div class="flex items-center space-x-4 mb-2">
        <%= link_to net_worth_path(month: (@valuation_date - 1.month).strftime("%Y-%m")), class: "text-slate-400 hover:text-slate-600" do %>
          ← <%= (@valuation_date - 1.month).strftime("%b %Y") %>
        <% end %>
        <h1 class="text-lg font-semibold text-slate-700"><%= @valuation_date.strftime("%B %Y") %></h1>
        <% if @valuation_date.end_of_month < Date.current.end_of_month %>
          <%= link_to net_worth_path(month: (@valuation_date + 1.month).strftime("%Y-%m")), class: "text-slate-400 hover:text-slate-600" do %>
            <%= (@valuation_date + 1.month).strftime("%b %Y") %> →
          <% end %>
        <% else %>
          <span class="text-slate-300">Now →</span>
        <% end %>
      </div>
      <p class="text-4xl font-bold text-slate-800"><%= format_currency(@net_worth[:net_worth], precision: 0) %></p>
      <% if @net_worth_change != 0 %>
        <p class="text-sm mt-1 <%= @net_worth_change >= 0 ? 'text-emerald-600' : 'text-rose-500' %>">
          <%= @net_worth_change >= 0 ? '+' : '' %><%= format_currency(@net_worth_change, precision: 0) %> from last month
        </p>
      <% end %>
    </div>
    
    <% if group_data.any? %>
      <div class="flex items-center">
        <svg width="100" height="100" viewBox="0 0 160 160">
          <% offset = 0 %>
          <% group_data.each do |group| %>
            <% arc_length = (group[:pct] * 3.77).round(2) %>
            <circle cx="80" cy="80" r="60" fill="none" 
                    stroke="<%= group[:color] %>" stroke-width="28"
                    stroke-dasharray="<%= arc_length %> 377"
                    stroke-dashoffset="<%= -offset %>"
                    transform="rotate(-90 80 80)" />
            <% offset += arc_length %>
          <% end %>
        </svg>
        
        <div class="space-y-2" style="margin-left: 2rem;">
          <% group_data.each do |group| %>
            <div class="flex items-center">
              <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= group[:color] %>"></span>
              <span class="text-sm text-slate-600 whitespace-nowrap ml-3 w-32"><%= group[:name] %></span>
              <span class="text-sm text-slate-700 whitespace-nowrap w-28 text-right"><%= format_currency(group[:value], precision: 0) %></span>
              <span class="text-sm text-slate-400 whitespace-nowrap w-12 text-right"><%= group[:pct] %>%</span>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <%= link_to "Cash Flow", cash_flow_path, class: "text-cyan-600 hover:text-cyan-700 hover:underline" %>
    <% end %>
  </div>

  <!-- Net Worth Summary -->
  <% if @net_worth[:net_worth] == 0 && @net_worth[:cash] == 0 && @net_worth[:assets] == 0 %>
    <div class="bg-white rounded-xl border border-slate-200 p-6">
      <p class="text-slate-500">No financial data yet. Add accounts or assets to get started.</p>
    </div>
  <% end %>

  <!-- Asset Groups Breakdown -->
  <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
    <div class="p-4 border-b border-slate-200 flex justify-between items-center">
      <h2 class="text-lg font-semibold text-slate-800">Assets</h2>
      <%= link_to "Update Values", update_valuations_path, class: "text-sm text-cyan-600 hover:text-cyan-700 hover:underline" %>
    </div>

    <% if @asset_groups.none? { |g| g.assets.any? } %>
      <div class="p-6 text-center">
        <p class="text-slate-500 mb-4">No assets yet.</p>
        <%= link_to "Add an asset", new_asset_path, class: "text-cyan-600 hover:underline" %>
      </div>
    <% else %>
      <table class="w-full">
        <tbody>
          <% @asset_groups.each_with_index do |group, group_index| %>
            <% next if group.assets.empty? %>

            <tr class="bg-slate-200 <%= group_index > 0 ? 'border-t-4 border-slate-300' : '' %>">
              <td class="px-4 py-2">
                <span class="font-semibold text-slate-700 whitespace-nowrap"><%= group.name %></span>
              </td>
              <td></td>
            </tr>

            <% group.assets.includes(:asset_type).order(:position, :name).each do |asset| %>
              <% valuation = @valuations_by_asset[asset.id] %>
              <tr class="hover:bg-slate-50 transition border-t border-slate-100">
                <td class="px-4 py-3">
                  <%= link_to asset, class: "block" do %>
                    <p class="text-sm font-medium text-slate-700 hover:text-cyan-600 whitespace-nowrap"><%= asset.name %></p>
                    <p class="text-xs text-slate-400 whitespace-nowrap">
                      <%= asset.asset_type.name %> · <%= asset.currency %><% if asset.asset_type.is_liability %> · <span class="text-rose-400">Liability</span><% end %>
                    </p>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-right whitespace-nowrap">
                  <% if valuation %>
                    <span class="text-sm text-slate-700">
                      <%= asset.asset_type.is_liability ? '-' : '' %><%= format_currency(valuation.value_in_default_currency || 0, precision: 0) %>
                    </span>
                    <% if asset.currency != @default_currency %>
                      <p class="text-xs text-slate-400"><%= asset.currency %> <%= format_amount(valuation.value) %></p>
                    <% end %>
                  <% else %>
                    <span class="text-sm text-slate-300">—</span>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <tr class="bg-slate-50 border-t border-slate-200">
              <td class="px-4 py-2"></td>
              <td class="px-4 py-2 text-right">
                <% net_value = @group_totals[group.id] %>
                <% if net_value && net_value != 0 %>
                  <span class="font-semibold text-sm whitespace-nowrap text-slate-600"><%= format_currency(net_value, precision: 0) %></span>
                <% end %>
              </td>
            </tr>
          <% end %>

          <tr class="bg-slate-200 border-t-4 border-slate-300">
            <td class="px-4 py-3">
              <span class="font-bold text-slate-800 whitespace-nowrap">Total Net Worth</span>
            </td>
            <td class="px-4 py-3 text-right">
              <span class="font-bold text-sm whitespace-nowrap text-slate-700"><%= format_currency(@totals[:net], precision: 0) %></span>
            </td>
          </tr>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
