<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Reports" %>
    <%= ui_breadcrumb_item "Net Worth", net_worth_path %>
  <% end %>
<% end %>

<div class="space-y-6">
  <%
    # Calculate totals for chart using selected month's valuations
    # Uses net values (assets - liabilities) per group
    # Includes both active assets and archived assets with valuations for the selected month
    default_colors = %w[#60a5fa #4ade80 #f87171 #a78bfa #fb923c #22d3ee #e879f9 #facc15 #94a3b8 #2dd4bf]

    # Build group data using net values from controller
    group_data = []
    @asset_groups.each_with_index do |group, idx|
      net_value = @group_totals[group.id] || 0
      next if net_value == 0
      group_data << {
        name: group.name,
        value: net_value,
        pct: 0, # calculated below
        color: group.color || default_colors[idx % default_colors.length],
      }
    end

    # Calculate percentages based on net values
    total_net = group_data.sum { |g| g[:value] }
    group_data.each do |g|
      g[:pct] = total_net > 0 ? (g[:value].to_f / total_net * 100).round : 0
    end
  %>

  <div class="flex justify-between items-start">
    <div>
      <p class="<%= ui_display_number_class %>"><%= format_currency(@net_worth[:net_worth], precision: 0) %></p>
      <% if @net_worth_change != 0 %>
        <p class="text-sm mt-1 <%= @net_worth_change >= 0 ? ui_positive_class : ui_negative_class %>">
          <%= @net_worth_change >= 0 ? '+' : '' %><%= format_currency(@net_worth_change, precision: 0) %> from last month
        </p>
      <% end %>
    </div>
    <div class="flex flex-col items-end gap-4">
      <div class="flex items-center space-x-4">
        <%= link_to net_worth_path(month: (@valuation_date - 1.month).strftime("%Y-%m")), class: "text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300" do %>
          ← <%= (@valuation_date - 1.month).strftime("%B %Y") %>
        <% end %>
        <span class="font-semibold <%= ui_text_class %>"><%= @valuation_date.strftime("%B %Y") %></span>
        <% if @valuation_date.end_of_month < Date.current.end_of_month %>
          <%= link_to net_worth_path(month: (@valuation_date + 1.month).strftime("%Y-%m")), class: "text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300" do %>
            <%= (@valuation_date + 1.month).strftime("%B %Y") %> →
          <% end %>
        <% else %>
          <span class="text-slate-300 dark:text-slate-600">Now →</span>
        <% end %>
      </div>
      <% if group_data.any? %>
        <% chart_size = group_data.size * 22 %>
        <div class="flex items-center gap-6">
          <svg width="<%= chart_size %>" height="<%= chart_size %>" class="flex-shrink-0" viewBox="0 0 160 160">
            <% offset = 0 %>
            <% group_data.each do |group| %>
              <% arc_length = (group[:pct] * 3.77).round(2) %>
              <circle cx="80" cy="80" r="60" fill="none" 
                      stroke="<%= group[:color] %>" stroke-width="35"
                      stroke-dasharray="<%= arc_length %> 377"
                      stroke-dashoffset="<%= -offset %>"
                      transform="rotate(-90 80 80)" />
              <% offset += arc_length %>
            <% end %>
          </svg>
          
          <table class="text-sm ml-auto">
            <% group_data.each do |group| %>
              <tr>
                <td class="py-0.5 pr-2 align-middle"><svg width="12" height="12"><rect width="12" height="12" fill="<%= group[:color] %>"/></svg></td>
                <td class="py-0.5 pr-12 <%= ui_text_muted_class %> text-left"><%= group[:name] %></td>
                <td class="py-0.5 pr-3 <%= ui_text_class %> text-right tabular-nums"><%= format_currency(group[:value], precision: 0) %></td>
                <td class="py-0.5 <%= ui_text_subtle_class %> text-right tabular-nums w-10"><%= group[:pct] %>%</td>
              </tr>
            <% end %>
          </table>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Net Worth Summary -->
  <% if @net_worth[:net_worth] == 0 && @net_worth[:cash] == 0 && @net_worth[:assets] == 0 %>
    <div class="<%= ui_card_class %> p-6">
      <p class="<%= ui_text_muted_class %>">No financial data yet. Add accounts or assets to get started.</p>
    </div>
  <% end %>

  <!-- History Bar Charts -->
  <% if @asset_groups.any? { |g| g.assets.any? } %>
    <%
      chart_height = 150
      
      max_value = @history_months.map { |m| 
        @asset_groups.sum { |g| [@history_by_group[g.id][m] || 0, 0].max }
      }.max || 1
      
      max_value_q = @history_quarters.map { |q| 
        @asset_groups.sum { |g| [@history_by_group_quarterly[g.id][q] || 0, 0].max }
      }.max || 1
    %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Monthly Chart -->
      <div class="<%= ui_card_class %> p-4">
        <h2 class="<%= ui_subheading_class %> mb-3">Monthly</h2>
        <div class="w-full px-2">
          <svg class="w-full" height="<%= chart_height %>" viewBox="0 0 100 <%= chart_height %>" preserveAspectRatio="none">
            <% bar_pct = 7 %>
            <% gap_pct = 1.33 %>
            <% start_offset = (gap_pct / 2) %>
            <% @history_months.each_with_index do |month, month_idx| %>
              <% x_pct = start_offset + month_idx * (bar_pct + gap_pct) %>
              <% y_offset = 0 %>
              <% month_total = @asset_groups.sum { |g| @history_by_group[g.id][month] || 0 } %>
              
              <% @asset_groups.to_a.reverse.each do |group| %>
                <% value = @history_by_group[group.id][month] || 0 %>
                <% next if value <= 0 %>
                <% bar_height = (value.to_f / max_value * chart_height).round %>
                <% y = chart_height - y_offset - bar_height %>
                <% pct = month_total > 0 ? (value.to_f / month_total * 100).round(1) : 0 %>
                
                <rect x="<%= x_pct %>%" y="<%= y %>" width="<%= bar_pct %>%" height="<%= bar_height %>"
                      fill="<%= group.color || '#94a3b8' %>">
                  <title><%= group.name %>: <%= format_currency(value, precision: 0) %> (<%= pct %>%)</title>
                </rect>
                
                <% y_offset += bar_height %>
              <% end %>
            <% end %>
          </svg>
          <div class="flex" style="font-size: 9px;">
            <% @history_months.each_with_index do |month, month_idx| %>
              <div style="width: <%= bar_pct + gap_pct %>%; text-align: center;">
                <div class="<%= ui_text_muted_class %>"><%= month.strftime("%b")[0] %></div>
                <% if month.month == 1 || month_idx == 0 %>
                  <div class="<%= ui_text_subtle_class %>"><%= month.strftime("%y") %></div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Quarterly Chart -->
      <div class="<%= ui_card_class %> p-4">
        <h2 class="<%= ui_subheading_class %> mb-3">Quarterly</h2>
        <div class="w-full px-2">
          <svg class="w-full" height="<%= chart_height %>" viewBox="0 0 100 <%= chart_height %>" preserveAspectRatio="none">
            <% bar_pct = 7 %>
            <% gap_pct = 1.33 %>
            <% start_offset = (gap_pct / 2) %>
            <% @history_quarters.each_with_index do |quarter, q_idx| %>
              <% x_pct = start_offset + q_idx * (bar_pct + gap_pct) %>
              <% y_offset = 0 %>
              <% quarter_total = @asset_groups.sum { |g| @history_by_group_quarterly[g.id][quarter] || 0 } %>
              
              <% @asset_groups.to_a.reverse.each do |group| %>
                <% value = @history_by_group_quarterly[group.id][quarter] || 0 %>
                <% next if value <= 0 %>
                <% bar_height = (value.to_f / max_value_q * chart_height).round %>
                <% y = chart_height - y_offset - bar_height %>
                <% pct = quarter_total > 0 ? (value.to_f / quarter_total * 100).round(1) : 0 %>
                
                <rect x="<%= x_pct %>%" y="<%= y %>" width="<%= bar_pct %>%" height="<%= bar_height %>"
                      fill="<%= group.color || '#94a3b8' %>">
                  <title><%= group.name %>: <%= format_currency(value, precision: 0) %> (<%= pct %>%)</title>
                </rect>
                
                <% y_offset += bar_height %>
              <% end %>
            <% end %>
          </svg>
          <div class="flex" style="font-size: 9px;">
            <% @history_quarters.each_with_index do |quarter, q_idx| %>
              <div style="width: <%= bar_pct + gap_pct %>%; text-align: center;">
                <div class="<%= ui_text_muted_class %>">Q<%= ((quarter.month - 1) / 3) + 1 %></div>
                <% if quarter.month <= 3 || q_idx == 0 %>
                  <div class="<%= ui_text_subtle_class %>"><%= quarter.strftime("%y") %></div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Asset Groups Breakdown -->
  <div class="<%= ui_card_table_class %>">
    <% 
      # Check if any group has assets to show (active or archived with valuations)
      has_assets_to_show = @asset_groups.any? do |group|
        group.assets.active.any? || group.assets.archived.any? { |a| @valuations_by_asset[a.id].present? }
      end
    %>
    <% if !has_assets_to_show %>
      <div class="<%= ui_empty_class %>">
        <p class="<%= ui_text_muted_class %> mb-4">No assets yet.</p>
        <%= link_to "Add an asset", new_asset_path, class: ui_link_class %>
      </div>
    <% else %>
      <table class="w-full">
        <thead class="<%= ui_table_header_class %>">
          <tr>
            <th class="<%= ui_table_th_class %>">Assets</th>
            <th class="<%= ui_table_th_class %>"></th>
            <th class="<%= ui_table_th_class %> w-16"></th>
          </tr>
        </thead>
        <tbody>
          <% @asset_groups.each_with_index do |group, group_index| %>
            <% active_assets = group.assets.active.includes(:asset_type).order(:position, :name) %>
            <% archived_with_valuations = group.assets.archived.includes(:asset_type).order(:position, :name).select { |a| @valuations_by_asset[a.id].present? } %>
            <% next if active_assets.empty? && archived_with_valuations.empty? %>
            <% group_has_liabilities = active_assets.any? { |a| a.asset_type.is_liability } || archived_with_valuations.any? { |a| a.asset_type.is_liability } %>

            <tr class="<%= ui_table_group_header_class %> <%= group_index > 0 ? 'border-t-4 border-slate-300 dark:border-slate-500' : '' %>">
              <td class="px-4 py-2">
                <span class="inline-flex items-center">
                  <svg class="flex-shrink-0 mr-2" width="16" height="16"><rect width="16" height="16" fill="<%= group.color || '#94a3b8' %>"/></svg>
                  <span class="font-semibold <%= ui_table_group_text_class %> whitespace-nowrap"><%= group.name %></span>
                </span>
              </td>
              <td></td>
              <td></td>
            </tr>

            <%# Active assets %>
            <% active_assets.each do |asset| %>
              <% valuation = @valuations_by_asset[asset.id] %>
              <% 
                asset_value = valuation ? (valuation.value_in_default_currency || 0) : 0
                asset_value = -asset_value if asset.asset_type.is_liability
                asset_pct = @totals[:net] > 0 ? (asset_value.to_f / @totals[:net] * 100).round : 0
              %>
              <tr class="<%= ui_table_row_class %>">
                <td class="<%= ui_table_td_class %>">
                  <%= link_to asset, class: "block" do %>
                    <p class="text-sm font-medium <%= ui_text_class %> hover:text-cyan-600 dark:hover:text-cyan-400 whitespace-nowrap">
                      <%= asset.name %>
                      <% if @broker_asset_ids.include?(asset.id) %>
                        <span class="ml-1 <%= ui_badge_info_class %>">Broker</span>
                      <% end %>
                    </p>
                    <p class="text-xs <%= ui_text_subtle_class %> whitespace-nowrap">
                      <%= asset.asset_type.name %> · <%= asset.currency %><% if asset.asset_type.is_liability %> <span class="ml-1 <%= ui_badge_danger_class %>">Liability</span><% end %>
                    </p>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <% unless group_has_liabilities %>
                    <span class="text-sm text-slate-400 dark:text-slate-500 tabular-nums"><%= asset_pct %>%</span>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <% if valuation %>
                    <span class="text-sm <%= ui_text_class %>">
                      <%= asset.asset_type.is_liability ? '-' : '' %><%= format_currency(valuation.value_in_default_currency || 0, precision: 0) %>
                    </span>
                    <% if asset.currency != @default_currency %>
                      <p class="text-xs <%= ui_text_subtle_class %>"><%= format_currency(valuation.value, currency: asset.currency, precision: 0) %></p>
                    <% end %>
                  <% else %>
                    <span class="text-sm <%= ui_text_subtle_class %>">—</span>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <%# Archived assets with valuations - shown inline with label %>
            <% archived_with_valuations.each do |asset| %>
              <% valuation = @valuations_by_asset[asset.id] %>
              <% 
                asset_value = valuation ? (valuation.value_in_default_currency || 0) : 0
                asset_value = -asset_value if asset.asset_type.is_liability
                asset_pct = @totals[:net] > 0 ? (asset_value.to_f / @totals[:net] * 100).round : 0
              %>
              <tr class="<%= ui_table_row_class %>">
                <td class="<%= ui_table_td_class %>">
                  <%= link_to asset, class: "block" do %>
                    <p class="text-sm font-medium <%= ui_text_subtle_class %> hover:text-cyan-600 dark:hover:text-cyan-400 whitespace-nowrap">
                      <%= asset.name %>
                      <span class="ml-1 <%= ui_badge_class %>">Archived</span>
                    </p>
                    <p class="text-xs <%= ui_text_subtle_class %> whitespace-nowrap">
                      <%= asset.asset_type.name %> · <%= asset.currency %><% if asset.asset_type.is_liability %> <span class="ml-1 <%= ui_badge_danger_class %>">Liability</span><% end %>
                    </p>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <% unless group_has_liabilities %>
                    <span class="text-sm text-slate-400 dark:text-slate-500 tabular-nums"><%= asset_pct %>%</span>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %> text-right whitespace-nowrap">
                  <span class="text-sm <%= ui_text_subtle_class %>">
                    <%= asset.asset_type.is_liability ? '-' : '' %><%= format_currency(valuation.value_in_default_currency || 0, precision: 0) %>
                  </span>
                  <% if asset.currency != @default_currency %>
                    <p class="text-xs <%= ui_text_subtle_class %>"><%= format_currency(valuation.value, currency: asset.currency, precision: 0) %></p>
                  <% end %>
                </td>
              </tr>
            <% end %>

            <% 
              group_pct = @totals[:net] > 0 && @group_totals[group.id] ? (@group_totals[group.id].to_f / @totals[:net] * 100).round : 0
            %>
            <tr class="<%= ui_table_subtotal_class %>">
              <td class="px-4 py-2"></td>
              <td class="px-4 py-2 text-right">
                <% if @group_totals[group.id] && @group_totals[group.id] != 0 %>
                  <span class="font-semibold text-sm text-slate-400 dark:text-slate-500 tabular-nums"><%= group_pct %>%</span>
                <% end %>
              </td>
              <td class="px-4 py-2 text-right">
                <% net_value = @group_totals[group.id] %>
                <% if net_value && net_value != 0 %>
                  <span class="font-semibold text-sm whitespace-nowrap <%= ui_text_muted_class %>"><%= format_currency(net_value, precision: 0) %></span>
                <% end %>
              </td>
            </tr>
          <% end %>

          <tr class="<%= ui_table_total_class %>">
            <td class="px-4 py-3">
              <span class="font-bold <%= ui_table_group_text_class %> whitespace-nowrap">Total Net Worth</span>
            </td>
            <td class="px-4 py-3 text-right">
              <span class="font-bold text-sm text-slate-400 dark:text-slate-500 tabular-nums">100%</span>
            </td>
            <td class="px-4 py-3 text-right">
              <span class="font-bold text-sm whitespace-nowrap <%= ui_table_group_text_class %>"><%= format_currency(@totals[:net], precision: 0) %></span>
            </td>
          </tr>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
