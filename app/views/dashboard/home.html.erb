<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Home" %>
  <% end %>
<% end %>

<div class="space-y-6">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Net Worth Section -->
    <div class="bg-white dark:bg-slate-800 p-6">
      <div class="mb-4">
        <%= link_to net_worth_path, class: "hover:text-cyan-600 dark:hover:text-cyan-400" do %>
          <h2 class="<%= ui_heading_class %> hover:text-cyan-600 dark:hover:text-cyan-400">Net Worth →</h2>
        <% end %>
        <p class="text-xs <%= ui_text_subtle_class %>"><%= @valuation_date.strftime("%B %Y") %></p>
      </div>

      <% group_data = build_chart_group_data(@asset_groups, @group_totals) %>
      <% if group_data.any? %>

        <div class="flex items-center justify-between mb-6">
          <div>
            <p class="text-3xl font-bold <%= ui_text_class %>"><%= format_currency(@net_worth[:net_worth], precision: 0) %></p>
            <p class="text-sm <%= @net_worth_change >= 0 ? ui_positive_class : ui_negative_class %>">
              <%= @net_worth_change >= 0 ? '+' : '' %><%= format_currency(@net_worth_change, precision: 0) %> from last month
            </p>
          </div>

          <!-- Donut Chart -->
          <div data-controller="chart-tooltip" style="position: relative;">
            <svg width="100" height="100" viewBox="0 0 42 42" class="flex-shrink-0">
              <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#f1f5f9" stroke-width="8" class="dark:stroke-slate-700"></circle>
              <%
                cumulative = 0
                group_data.each do |group|
                  dash = group[:pct]
                  gap = 100 - dash
                  offset = 25 - cumulative
              %>
                <circle cx="21" cy="21" r="15.91549430918954" fill="transparent"
                        stroke="<%= group[:color] %>" stroke-width="8"
                        stroke-dasharray="<%= dash %> <%= gap %>"
                        stroke-dashoffset="<%= offset %>"
                        style="pointer-events: stroke;"
                        data-tooltip="<%= group[:name] %>: <%= format_currency_plain(group[:value], precision: 0) %> (<%= group[:pct] %>%)"></circle>
              <% cumulative += dash; end %>
            </svg>
            <%= render "shared/chart_tooltip" %>
          </div>
        </div>

        <!-- Legend -->
        <div class="space-y-1">
          <% group_data.each do |group| %>
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center">
                <svg class="flex-shrink-0 mr-2" width="12" height="12"><rect width="12" height="12" fill="<%= group[:color] %>"/></svg>
                <span class="<%= ui_text_muted_class %>"><%= group[:name] %></span>
              </div>
              <div class="flex items-center gap-3">
                <span class="<%= ui_text_class %> font-medium"><%= format_currency(group[:value], precision: 0) %></span>
                <span class="<%= ui_text_subtle_class %> w-12 text-right"><%= group[:pct] %>%</span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="<%= ui_text_muted_class %>">No asset valuations yet.</p>
      <% end %>
    </div>

    <!-- Cash Flow Section -->
    <div class="bg-white dark:bg-slate-800 p-6">
      <div class="mb-4">
        <%= link_to cash_flow_path, class: "hover:text-cyan-600 dark:hover:text-cyan-400" do %>
          <h2 class="<%= ui_heading_class %> hover:text-cyan-600 dark:hover:text-cyan-400">Cash Flow →</h2>
        <% end %>
        <p class="text-xs <%= ui_text_subtle_class %>">Last 3 completed months</p>
      </div>

      <% if @monthly_cash_flow.any? %>
        <div class="space-y-4">
          <% @monthly_cash_flow.each do |month| %>
            <div class="border-b border-slate-100 dark:border-slate-700 pb-3 last:border-0 last:pb-0">
              <div class="font-medium <%= ui_text_class %> mb-2"><%= month[:month_name] %></div>
              <% if month[:income] > 0 %>
                <% expense_pct = (month[:expenses].to_f / month[:income] * 100).round %>
                <% is_over = expense_pct > 100 %>
                <% bar_pct = [expense_pct, 100].min %>
                <% saved_pct = 100 - bar_pct %>
                <div style="height: 20px; display: flex;" class="text-xs overflow-hidden">
                  <div style="width: <%= bar_pct %>%; background: <%= is_over ? '#e11d48' : '#94a3b8' %>;" class="h-full flex items-center justify-start pl-1">
                    <% if bar_pct > 20 %><span class="text-white"><%= expense_pct %>%</span><% end %>
                  </div>
                  <% if saved_pct > 0 %>
                    <div style="width: <%= saved_pct %>%; background: rgba(148, 163, 184, 0.15);" class="h-full flex items-center justify-end pr-1">
                      <% if saved_pct > 20 %><span class="text-slate-400"><%= saved_pct %>%</span><% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
              <div class="flex justify-between text-sm mt-2">
                <span class="<%= ui_text_class %>"><%= format_currency(month[:income], precision: 0) %></span>
                <span class="<%= ui_negative_class %>">-<%= format_currency(month[:expenses], precision: 0) %></span>
                <span class="font-medium <%= month[:net] >= 0 ? ui_text_class : ui_negative_class %>">
                  = <%= format_currency(month[:net], precision: 0) %>
                </span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="<%= ui_text_muted_class %>">No transactions yet.</p>
      <% end %>
    </div>
  </div>

  <%# Coverage Gaps Panel - show if there are account gaps or incomplete months %>
  <% if @coverage_gaps.any? || @incomplete_months.any? %>
    <div class="bg-white dark:bg-slate-800 p-6">
      <div class="mb-4">
        <%= link_to imports_path, class: "hover:text-cyan-600 dark:hover:text-cyan-400" do %>
          <h2 class="<%= ui_heading_class %> hover:text-cyan-600 dark:hover:text-cyan-400">Coverage Gaps →</h2>
        <% end %>
        <p class="text-xs <%= ui_text_subtle_class %>">
          <% parts = [] %>
          <% parts << "#{@coverage_gaps.size} account#{@coverage_gaps.size == 1 ? '' : 's'} with gaps" if @coverage_gaps.any? %>
          <% parts << "#{@incomplete_months.size} incomplete month#{@incomplete_months.size == 1 ? '' : 's'}" if @incomplete_months.any? %>
          <%= parts.join(", ") %>
        </p>
      </div>

      <% if @incomplete_months.any? %>
        <div class="mb-3 pb-3 border-b border-slate-100 dark:border-slate-700">
          <div class="space-y-0.5">
            <% @incomplete_months.each do |ym| %>
              <% month_date = Date.parse("#{ym}-01") %>
              <%= link_to cash_flow_path(year: month_date.year, month: month_date.month),
                    class: "block text-xs text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300" do %>
                Incomplete: <%= month_date.strftime("%b %Y") %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @coverage_gaps.any? %>
        <div class="space-y-3">
          <% @coverage_gaps.each do |coverage| %>
            <%= render "shared/coverage_row", coverage: coverage %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
