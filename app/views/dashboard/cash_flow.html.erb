<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Reports" %>
    <%= ui_breadcrumb_item "Cash Flow", cash_flow_path %>
  <% end %>
<% end %>

<%# Calculate previous/next month navigation for keyboard shortcuts %>
<% if @selected_month %>
  <% nav_prev_month = @selected_month == 1 ? 12 : @selected_month - 1 %>
  <% nav_prev_year = @selected_month == 1 ? @selected_year - 1 : @selected_year %>
  <% nav_next_month = @selected_month == 12 ? 1 : @selected_month + 1 %>
  <% nav_next_year = @selected_month == 12 ? @selected_year + 1 : @selected_year %>
<% else %>
  <% nav_prev_month = 12 %>
  <% nav_prev_year = @selected_year - 1 %>
  <% nav_next_month = 1 %>
  <% nav_next_year = @selected_year %>
<% end %>
<% nav_can_go_prev = nav_prev_year >= @min_year %>
<% nav_next_month_date = Date.new(nav_next_year, nav_next_month, 1) %>
<% nav_can_go_next = nav_next_year <= @max_year && nav_next_month_date <= Date.current %>

<div class="space-y-6"
     data-controller="month-navigation"
     <%= "data-month-navigation-prev-url-value=#{cash_flow_path(year: nav_prev_year, month: nav_prev_month)}" if nav_can_go_prev %>
     <%= "data-month-navigation-next-url-value=#{cash_flow_path(year: nav_next_year, month: nav_next_month)}" if nav_can_go_next %>
     <%= "data-month-navigation-prev-year-url-value=#{cash_flow_path(year: @selected_year - 1)}" if @selected_year > @min_year %>
     <%= "data-month-navigation-next-year-url-value=#{cash_flow_path(year: @selected_year + 1)}" if @selected_year < @max_year %>>
  <!-- Navigation -->
  <div class="sticky top-0 z-10 bg-white dark:bg-slate-900 py-3 -mx-4 px-4 flex flex-wrap items-center justify-between gap-4">
    <!-- Month Filter Tabs with Navigation Arrows -->
    <div class="flex flex-wrap items-center gap-2">
      <%# Calculate previous/next month navigation %>
      <% if @selected_month %>
        <% prev_month = @selected_month == 1 ? 12 : @selected_month - 1 %>
        <% prev_year = @selected_month == 1 ? @selected_year - 1 : @selected_year %>
        <% next_month = @selected_month == 12 ? 1 : @selected_month + 1 %>
        <% next_year = @selected_month == 12 ? @selected_year + 1 : @selected_year %>
      <% else %>
        <%# Year view: left goes to Dec of prev year, right goes to Jan of current year %>
        <% prev_month = 12 %>
        <% prev_year = @selected_year - 1 %>
        <% next_month = 1 %>
        <% next_year = @selected_year %>
      <% end %>
      <% can_go_prev = prev_year >= @min_year %>
      <% next_month_date = Date.new(next_year, next_month, 1) %>
      <% can_go_next = next_year <= @max_year && next_month_date <= Date.current %>

      <%# Year button %>
      <%= link_to "Year", cash_flow_path(year: @selected_year),
          class: @selected_month.nil? ? "px-3 py-1.5 text-sm font-medium bg-cyan-500 text-white mr-2" : "px-3 py-1.5 text-sm #{ui_text_muted_class} bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 mr-2",
          data: { action: "click->month-navigation#navigateLink" } %>

      <%# Left arrow - previous month %>
      <% if can_go_prev %>
        <%= link_to cash_flow_path(year: prev_year, month: prev_month),
            class: "pl-3 pr-1 py-1.5 text-sm #{ui_text_muted_class} hover:text-slate-900 dark:hover:text-white",
            title: "#{Date::MONTHNAMES[prev_month]} #{prev_year}",
            data: { action: "click->month-navigation#navigateLink" } do %>
          ←
        <% end %>
      <% else %>
        <span class="pl-3 pr-1 py-1.5 text-sm text-slate-300 dark:text-slate-600">←</span>
      <% end %>

      <div class="flex flex-wrap gap-1">
        <% (1..12).each do |m| %>
          <% is_future = Date.new(@selected_year, m, 1) > Date.current %>
          <%= link_to Date::ABBR_MONTHNAMES[m], cash_flow_path(year: @selected_year, month: m),
              class: [
                "px-3 py-1.5 text-sm",
                @selected_month == m ? "font-medium bg-cyan-500 text-white" : "#{ui_text_muted_class} bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600",
                is_future ? "opacity-50" : ""
              ].join(" "),
              data: { action: "click->month-navigation#navigateLink" } %>
        <% end %>
      </div>

      <%# Right arrow - next month %>
      <% if can_go_next %>
        <%= link_to cash_flow_path(year: next_year, month: next_month),
            class: "pl-1 pr-3 py-1.5 text-sm #{ui_text_muted_class} hover:text-slate-900 dark:hover:text-white",
            title: "#{Date::MONTHNAMES[next_month]} #{next_year}",
            data: { action: "click->month-navigation#navigateLink" } do %>
          →
        <% end %>
      <% else %>
        <span class="pl-1 pr-3 py-1.5 text-sm text-slate-300 dark:text-slate-600">→</span>
      <% end %>
    </div>

    <!-- Year Navigation (matching net_worth style) -->
    <div class="flex items-center space-x-4">
      <% if @selected_year > @min_year %>
        <%= link_to cash_flow_path(year: @selected_year - 1, month: @selected_month), class: "text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300", data: { action: "click->month-navigation#navigateLink" } do %>
          ← <%= @selected_year - 1 %>
        <% end %>
      <% else %>
        <span class="text-slate-300 dark:text-slate-600">← <%= @selected_year - 1 %></span>
      <% end %>

      <span class="font-semibold <%= ui_text_class %>"><%= @selected_year %></span>

      <% if @selected_year < @max_year %>
        <%= link_to cash_flow_path(year: @selected_year + 1, month: @selected_month), class: "text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300", data: { action: "click->month-navigation#navigateLink" } do %>
          <%= @selected_year + 1 %> →
        <% end %>
      <% else %>
        <span class="text-slate-300 dark:text-slate-600">Now →</span>
      <% end %>
    </div>
  </div>

  <!-- Summary and Donut Chart side by side -->
  <% chart_data = build_nested_donut_data(@income_by_category, @expense_by_category, @period_totals, scheme: :blue_red) %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Summary Donut (Saving Rate) -->
    <div class="<%= ui_card_class %> p-6">
      <h3 class="<%= ui_subheading_class %> mb-4">
        <%= @selected_month ? Date::MONTHNAMES[@selected_month] : "Year" %> <%= @selected_year %>
      </h3>

      <div class="flex flex-col items-center">
        <!-- Saving Rate Donut -->
        <% income = @period_totals[:income] %>
        <% expenses = @period_totals[:expenses] %>
        <% net = @period_totals[:net] %>
        <% saving_rate = @period_totals[:saving_rate] %>
        <% expense_pct = income > 0 ? [(expenses.to_f / income * 100).round, 100].min : 0 %>
        <% saved_pct = income > 0 ? [100 - expense_pct, 0].max : 0 %>

        <div data-controller="chart-tooltip" style="position: relative;">
          <svg width="300" height="300" viewBox="0 0 300 300" class="flex-shrink-0">
            <% circumference_outer = 2 * Math::PI * 120 %>
            <% circumference_inner = 2 * Math::PI * 70 %>
            
            <!-- Outer ring: Expenses + Savings (relative to income) -->
            <% if income > 0 %>
              <!-- Expenses arc (rose) -->
              <circle cx="150" cy="150" r="120" fill="none"
                      stroke="#fb7185"
                      stroke-width="40"
                      stroke-dasharray="<%= expense_pct / 100.0 * circumference_outer %> <%= circumference_outer %>"
                      transform="rotate(-90 150 150)"
                      style="pointer-events: stroke;"
                      data-tooltip="Spent: <%= format_currency_plain(expenses, precision: 0) %> (<%= expense_pct %>%)">
              </circle>
              <!-- Savings arc (transparent gap) -->
              <% if saved_pct > 0 %>
                <circle cx="150" cy="150" r="120" fill="none"
                        stroke="#94a3b8" stroke-opacity="0.15"
                        stroke-width="40"
                        stroke-dasharray="<%= saved_pct / 100.0 * circumference_outer %> <%= circumference_outer %>"
                        transform="rotate(<%= -90 + (expense_pct / 100.0 * 360) %> 150 150)"
                        style="pointer-events: stroke;"
                        data-tooltip="Saved: <%= format_currency_plain(net, precision: 0) %> (<%= saved_pct %>%)">
                </circle>
              <% end %>
            <% else %>
              <!-- Background circle when no income -->
              <circle cx="150" cy="150" r="120" fill="none"
                      class="stroke-slate-200 dark:stroke-slate-700"
                      stroke-width="40"/>
            <% end %>

            <!-- Inner ring: Full income (shows total) -->
            <% if income > 0 %>
              <circle cx="150" cy="150" r="70" fill="none"
                      stroke="#60a5fa"
                      stroke-width="35"
                      stroke-dasharray="<%= circumference_inner %> 0"
                      transform="rotate(-90 150 150)"
                      style="pointer-events: stroke;"
                      data-tooltip="Income: <%= format_currency_plain(income, precision: 0) %>">
              </circle>
            <% else %>
              <circle cx="150" cy="150" r="70" fill="none"
                      class="stroke-slate-200 dark:stroke-slate-700"
                      stroke-width="35"/>
            <% end %>

            <!-- Center text -->
            <text x="150" y="145" text-anchor="middle"
                  class="text-xl font-bold <%= net >= 0 ? 'fill-emerald-600 dark:fill-emerald-400' : 'fill-rose-500 dark:fill-rose-400' %>">
              <%= saving_rate %>%
            </text>
            <text x="150" y="165" text-anchor="middle" class="text-xs fill-slate-400">
              <%= net >= 0 ? 'Saving Rate' : 'Deficit' %>
            </text>
          </svg>
          <%= render "shared/chart_tooltip" %>
        </div>

        <!-- Legend (3 rows, each with: name | percentage | value) -->
        <div class="mt-4 text-sm w-full space-y-1">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <span class="w-3 h-3 mr-2 flex-shrink-0" style="background: #60a5fa;"></span>
              <span class="<%= ui_text_muted_class %>">Income</span>
            </div>
            <div class="flex items-center">
              <span class="<%= ui_text_subtle_class %> tabular-nums text-right w-12">100%</span>
              <span class="<%= ui_text_class %> tabular-nums font-medium text-right w-28"><%= format_currency(income, precision: 0) %></span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <span class="w-3 h-3 mr-2 flex-shrink-0" style="background: #fb7185;"></span>
              <span class="<%= ui_text_muted_class %>">Expenses</span>
            </div>
            <div class="flex items-center">
              <span class="<%= ui_text_subtle_class %> tabular-nums text-right w-12"><%= expense_pct %>%</span>
              <span class="<%= ui_text_class %> tabular-nums font-medium text-right w-28"><%= format_currency(expenses, precision: 0) %></span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <span class="w-3 h-3 mr-2 flex-shrink-0" style="background: rgba(148, 163, 184, 0.15); border: 1px solid #94a3b8;"></span>
              <span class="<%= ui_text_muted_class %>">Saved</span>
            </div>
            <div class="flex items-center">
              <span class="<%= ui_text_subtle_class %> tabular-nums text-right w-12"><%= saved_pct %>%</span>
              <span class="<%= ui_text_class %> tabular-nums font-medium text-right w-28"><%= format_currency(net, precision: 0) %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Breakdown Donut -->
    <% if chart_data[:income].any? || chart_data[:expenses].any? %>
      <div class="<%= ui_card_class %> p-6">
        <h3 class="<%= ui_subheading_class %> mb-4">Categories</h3>
        <div class="flex flex-col md:flex-row items-start gap-8">
          <!-- SVG Donut -->
          <div data-controller="chart-tooltip" style="position: relative;" class="flex-shrink-0">
            <svg width="300" height="300" viewBox="0 0 300 300">
              <!-- Outer ring (expenses only - savings shown as gap) -->
              <% circumference_outer = 2 * Math::PI * 120 %>
              <% rotation_outer = -90 %>
              <% chart_data[:expenses].each do |segment| %>
                <% next if segment[:name] == "Savings" %>
                <% arc_length = (segment[:pct] / 100.0 * circumference_outer) %>
                <circle cx="150" cy="150" r="120" fill="none"
                        stroke="<%= segment[:color] %>"
                        stroke-width="40"
                        stroke-dasharray="<%= arc_length %> <%= circumference_outer - arc_length %>"
                        transform="rotate(<%= rotation_outer %> 150 150)"
                        class="transition-opacity duration-150"
                        style="pointer-events: stroke;"
                        data-tooltip="<%= segment[:name] %>: <%= format_currency_plain(segment[:value], precision: 0) %> (<%= segment[:pct] %>%)">
                </circle>
                <% rotation_outer += (segment[:pct] / 100.0 * 360) %>
              <% end %>

              <!-- Inner ring (income) -->
              <% circumference_inner = 2 * Math::PI * 70 %>
              <% rotation_inner = -90 %>
              <% chart_data[:income].each do |segment| %>
                <% arc_length = (segment[:pct] / 100.0 * circumference_inner) %>
                <circle cx="150" cy="150" r="70" fill="none"
                        stroke="<%= segment[:color] %>"
                        stroke-width="35"
                        stroke-dasharray="<%= arc_length %> <%= circumference_inner - arc_length %>"
                        transform="rotate(<%= rotation_inner %> 150 150)"
                        class="transition-opacity duration-150"
                        style="pointer-events: stroke;"
                        data-tooltip="<%= segment[:name] %>: <%= format_currency_plain(segment[:value], precision: 0) %> (<%= segment[:pct] %>%)">
                </circle>
                <% rotation_inner += (segment[:pct] / 100.0 * 360) %>
              <% end %>

              <!-- Center text -->
              <text x="150" y="145" text-anchor="middle"
                    class="text-xl font-bold <%= @period_totals[:net] >= 0 ? 'fill-emerald-600 dark:fill-emerald-400' : 'fill-rose-500 dark:fill-rose-400' %>">
                <%= @period_totals[:net] >= 0 ? '+' : '' %><%= number_to_currency(@period_totals[:net].abs, unit: '', precision: 0, delimiter: ',') %>
              </text>
              <text x="150" y="165" text-anchor="middle" class="text-xs fill-slate-400">
                <%= @period_totals[:net] >= 0 ? 'Net Savings' : 'Deficit' %>
              </text>
            </svg>
            <%= render "shared/chart_tooltip" %>
          </div>

          <!-- Legend -->
          <div class="space-y-4 text-sm max-w-64">
            <% if chart_data[:income].any? %>
              <div>
                <h4 class="font-medium <%= ui_text_class %> mb-2">Income</h4>
                <% chart_data[:income].each do |item| %>
                  <div class="flex items-center justify-between py-0.5 gap-8">
                    <div class="flex items-center">
                      <span class="w-3 h-3 mr-2 flex-shrink-0" style="background: <%= item[:color] %>"></span>
                      <% if item[:id] %>
                        <%
                          tx_path = if @selected_month
                            transactions_path(month: Date.new(@selected_year, @selected_month, 1).strftime("%Y-%m"), category_id: item[:id])
                          else
                            transactions_path(start_date: "#{@selected_year}-01-01", end_date: "#{@selected_year}-12-31", category_id: item[:id])
                          end
                        %>
                        <%= link_to item[:name], tx_path, class: "#{ui_text_muted_class} truncate hover:text-cyan-600 dark:hover:text-cyan-400 no-underline" %>
                      <% else %>
                        <span class="<%= ui_text_muted_class %> truncate"><%= item[:name] %></span>
                      <% end %>
                    </div>
                    <span class="<%= ui_text_class %> tabular-nums"><%= item[:pct] %>%</span>
                  </div>
                <% end %>
              </div>
            <% end %>
            <% if chart_data[:expenses].any? %>
              <div>
                <h4 class="font-medium <%= ui_text_class %> mb-2">Expenses</h4>
                <% chart_data[:expenses].reject { |item| item[:name] == 'Savings' }.each do |item| %>
                  <div class="flex items-center justify-between py-0.5 gap-8">
                    <div class="flex items-center">
                      <span class="w-3 h-3 mr-2 flex-shrink-0" style="background: <%= item[:color] %>"></span>
                      <% if item[:id] %>
                        <%
                          tx_path = if @selected_month
                            transactions_path(month: Date.new(@selected_year, @selected_month, 1).strftime("%Y-%m"), category_id: item[:id])
                          else
                            transactions_path(start_date: "#{@selected_year}-01-01", end_date: "#{@selected_year}-12-31", category_id: item[:id])
                          end
                        %>
                        <%= link_to item[:name], tx_path, class: "#{ui_text_muted_class} truncate hover:text-cyan-600 dark:hover:text-cyan-400 no-underline" %>
                      <% else %>
                        <span class="<%= ui_text_muted_class %> truncate"><%= item[:name] %></span>
                      <% end %>
                    </div>
                    <span class="<%= ui_text_class %> tabular-nums"><%= item[:pct] %>%</span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Monthly Bar Chart + Breakdown Table (only shown in full year view) -->
  <% unless @selected_month %>

  <%# ── Monthly Income vs Expenses Bar Chart ── %>
  <% chart_height = 150 %>
  <% max_value = @monthly_data.map { |m| [m[:income], m[:expenses]].max }.max || 0 %>
  <% y_ticks = chart_y_ticks(max_value) %>
  <% y_tick_max = y_ticks.last.to_f %>
  <div class="<%= ui_card_class %> p-6">
    <div class="flex w-full">
      <%# Y-axis labels %>
      <div class="flex flex-col justify-between text-right pr-2 flex-shrink-0" style="height: <%= chart_height %>px; font-size: 9px;">
        <% y_ticks.reverse.each do |tick| %>
          <span class="<%= ui_text_subtle_class %> leading-none"><%= format_y_axis_value(tick) %></span>
        <% end %>
      </div>
      <%# Chart area %>
      <div class="flex-1 min-w-0" data-controller="chart-tooltip" data-chart-tooltip-always-above-value="true" style="position: relative;">
        <svg class="w-full" height="<%= chart_height %>" viewBox="0 0 100 <%= chart_height %>" preserveAspectRatio="none">
          <%# Grid lines %>
          <% y_ticks.each do |tick| %>
            <% grid_y = y_tick_max > 0 ? chart_height - (tick.to_f / y_tick_max * chart_height) : chart_height %>
            <% is_baseline = tick == 0 %>
            <line x1="0" y1="<%= grid_y %>" x2="100" y2="<%= grid_y %>"
                  stroke="currentColor" class="<%= is_baseline ? 'text-slate-300 dark:text-slate-600' : 'text-slate-200 dark:text-slate-700' %>" stroke-width="<%= is_baseline ? 2 : 1 %>" vector-effect="non-scaling-stroke" />
          <% end %>

          <%# Grouped bars: income + expenses per month %>
          <% bar_w = 3.3 %>
          <% pair_gap = 0.4 %>
          <% month_gap = 1.4 %>
          <% pair_w = bar_w * 2 + pair_gap %>
          <% total_w = 12 * pair_w + 11 * month_gap %>
          <% start_offset = (100 - total_w) / 2.0 %>

          <%# Trailing 12-month average smooth curve (rendered first = behind bars) %>
          <% avg_points = [] %>
          <% @monthly_data.each_with_index do |month, idx| %>
            <% if month[:trailing_average] && y_tick_max > 0 %>
              <% x = start_offset + idx * (pair_w + month_gap) + bar_w + pair_gap + bar_w / 2.0 %>
              <% y = chart_height - (month[:trailing_average].to_f / y_tick_max * chart_height) %>
              <% avg_points << { x: x, y: y, month: month } %>
            <% end %>
          <% end %>
          <% if avg_points.size >= 2 %>
            <%
              # Build a smooth cubic bezier path through the points
              # Uses Catmull-Rom to Bezier conversion for natural curves
              path_d = "M #{avg_points[0][:x]},#{avg_points[0][:y]}"
              avg_points.each_with_index do |pt, i|
                next if i == 0
                p0 = avg_points[[i - 2, 0].max]
                p1 = avg_points[i - 1]
                p2 = pt
                p3 = avg_points[[i + 1, avg_points.size - 1].min]
                # Tension factor (0.25 = gentle curves)
                t = 0.25
                cp1x = p1[:x] + (p2[:x] - p0[:x]) * t
                cp1y = p1[:y] + (p2[:y] - p0[:y]) * t
                cp2x = p2[:x] - (p3[:x] - p1[:x]) * t
                cp2y = p2[:y] - (p3[:y] - p1[:y]) * t
                path_d += " C #{cp1x},#{cp1y} #{cp2x},#{cp2y} #{p2[:x]},#{p2[:y]}"
              end
            %>
            <path d="<%= path_d %>"
                  fill="none" stroke="#fda4af" stroke-width="1.5" stroke-opacity="0.5"
                  vector-effect="non-scaling-stroke" />
          <% end %>

          <% @monthly_data.each_with_index do |month, idx| %>
            <% x_base = start_offset + idx * (pair_w + month_gap) %>
            <% x_income = x_base %>
            <% x_expense = x_base + bar_w + pair_gap %>

            <%# Income bar %>
            <% if month[:income] > 0 && y_tick_max > 0 %>
              <% h = (month[:income].to_f / y_tick_max * chart_height).round %>
              <% y = chart_height - h %>
              <rect x="<%= x_income %>%" y="<%= y %>" width="<%= bar_w %>%" height="<%= h %>"
                    fill="#60a5fa" data-bar-group="cf<%= idx %>"
                    data-tooltip="<%= Date::ABBR_MONTHNAMES[month[:month]] %> <%= @selected_year %> · Income: <%= format_currency_plain(month[:income], precision: 0) %>">
              </rect>
            <% end %>

            <%# Expenses bar %>
            <% if month[:expenses] > 0 && y_tick_max > 0 %>
              <% h = (month[:expenses].to_f / y_tick_max * chart_height).round %>
              <% y = chart_height - h %>
              <rect x="<%= x_expense %>%" y="<%= y %>" width="<%= bar_w %>%" height="<%= h %>"
                    fill="#fb7185" data-bar-group="cf<%= idx %>"
                    data-tooltip="<%= Date::ABBR_MONTHNAMES[month[:month]] %> <%= @selected_year %> · Expenses: <%= format_currency_plain(month[:expenses], precision: 0) %>">
              </rect>
            <% end %>

            <%# Invisible overlay for combined tooltip %>
            <% if y_tick_max > 0 && (month[:income] > 0 || month[:expenses] > 0) %>
              <% max_h = ([month[:income], month[:expenses]].max.to_f / y_tick_max * chart_height).round %>
              <% gap_top = chart_height - max_h %>
              <% net = month[:income] - month[:expenses] %>
              <% if gap_top > 0 %>
                <rect x="<%= x_base %>%" y="0" width="<%= pair_w %>%" height="<%= gap_top %>"
                      fill="transparent" data-bar-group="cf<%= idx %>"
                      data-tooltip="<%= Date::ABBR_MONTHNAMES[month[:month]] %> <%= @selected_year %> · Income: <%= format_currency_plain(month[:income], precision: 0) %> / Expenses: <%= format_currency_plain(month[:expenses], precision: 0) %> / Net: <%= net >= 0 ? '+' : '' %><%= format_currency_plain(net, precision: 0) %>">
                </rect>
              <% end %>
            <% end %>
          <% end %>
        </svg>
        <%= render "shared/chart_tooltip" %>
        <%# X-axis month labels %>
        <div class="flex" style="font-size: 9px;">
          <% @monthly_data.each_with_index do |month, idx| %>
            <% label_w = pair_w + (idx < 11 ? month_gap : 0) %>
            <% ml = idx == 0 ? "margin-left: #{start_offset}%" : "" %>
            <div style="width: <%= label_w %>%; text-align: center; <%= ml %>">
              <span class="<%= ui_text_muted_class %>"><%= Date::ABBR_MONTHNAMES[month[:month]][0..2] %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="<%= ui_card_table_class %>">
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="<%= ui_table_header_class %>">
          <tr>
            <th class="<%= ui_table_th_class %>">Month</th>
            <th class="<%= ui_table_th_class %> text-right">Income</th>
            <th class="<%= ui_table_th_class %> text-right">Expenses</th>
            <th class="<%= ui_table_th_class %> text-right">Net</th>
            <th class="<%= ui_table_th_class %>" style="min-width: 200px;">Breakdown</th>
          </tr>
        </thead>
        <tbody class="border-t-[6px] border-slate-100 dark:border-slate-900">
          <% @monthly_data.each do |month| %>
            <% is_selected = @selected_month == month[:month] %>
            <% is_current = month[:date].year == Date.current.year && month[:date].month == Date.current.month %>
            <tr class="<%= is_selected ? 'bg-cyan-50/50 dark:bg-cyan-900/20 border-l-2 border-cyan-500' : (is_current ? 'bg-slate-50/50 dark:bg-slate-700/30' : ui_table_row_class) %>">
              <td class="<%= ui_table_td_class %> whitespace-nowrap">
                <%= link_to cash_flow_path(year: @selected_year, month: month[:month]), class: "font-medium #{ui_text_class} hover:text-cyan-600 dark:hover:text-cyan-400 no-underline" do %>
                  <%= Date::MONTHNAMES[month[:month]] %>
                <% end %>
                <% if is_current %>
                  <span class="ml-2 <%= ui_badge_info_class %>">Current</span>
                <% end %>
                <% if month[:is_future] %>
                  <span class="ml-2 <%= ui_text_subtle_class %> text-xs">Future</span>
                <% end %>
              </td>
              <td class="<%= ui_table_td_class %> whitespace-nowrap text-right <%= ui_text_muted_class %>">
                <% if month[:income] > 0 %>
                  <%= format_currency(month[:income]) %>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">-</span>
                <% end %>
              </td>
              <td class="<%= ui_table_td_class %> whitespace-nowrap text-right <%= ui_text_muted_class %>">
                <% if month[:expenses] > 0 %>
                  <% if month[:anomaly] %>
                    <span class="<%= ui_badge_danger_class %> mr-1 border-0" title="<%= month[:delta_percent] %>% above 12-month average">High</span>
                  <% end %>
                  <%= format_currency(month[:expenses]) %>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">-</span>
                <% end %>
              </td>

              <td class="<%= ui_table_td_class %> whitespace-nowrap text-right font-medium <%= month[:net] >= 0 ? ui_positive_class : ui_negative_class %>">
                <% if month[:income] > 0 || month[:expenses] > 0 %>
                  <%= month[:net] >= 0 ? '+' : '' %><%= format_currency(month[:net]) %>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">-</span>
                <% end %>
              </td>
              <td class="<%= ui_table_td_class %> whitespace-nowrap">
                <% if month[:income] > 0 %>
                  <% expense_pct = (month[:expenses].to_f / month[:income] * 100).round %>
                  <% is_over = expense_pct > 100 %>
                  <% bar_pct = [expense_pct, 100].min %>
                  <% saved_pct = 100 - bar_pct %>
                  <div style="height: 20px; display: flex;" class="text-xs overflow-hidden">
                    <div style="width: <%= bar_pct %>%; background: <%= is_over ? '#e11d48' : '#94a3b8' %>;" class="h-full flex items-center justify-start pl-1">
                      <% if bar_pct > 20 %><span class="text-white"><%= expense_pct %>%</span><% end %>
                    </div>
                    <% if saved_pct > 0 %>
                      <div style="width: <%= saved_pct %>%; background: rgba(148, 163, 184, 0.15);" class="h-full flex items-center justify-end pr-1">
                        <% if saved_pct > 20 %><span class="text-slate-400"><%= saved_pct %>%</span><% end %>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
          <tr class="bg-slate-200 dark:bg-slate-700 <%= ui_table_group_separator_class %>">
            <td class="px-4 py-3 font-bold <%= ui_text_class %>"><%= @selected_year %> Total</td>
            <td class="px-4 py-3 text-right font-bold <%= ui_text_class %>"><%= format_currency(@year_totals[:income]) %></td>
            <td class="px-4 py-3 text-right font-bold <%= ui_text_class %>"><%= format_currency(@year_totals[:expenses]) %></td>

            <td class="px-4 py-3 text-right font-bold <%= @year_totals[:net] >= 0 ? ui_positive_class : ui_negative_class %>">
              <%= @year_totals[:net] >= 0 ? '+' : '' %><%= format_currency(@year_totals[:net]) %>
            </td>
            <td class="px-4 py-3">
              <% if @year_totals[:income] > 0 %>
                <% expense_pct = (@year_totals[:expenses].to_f / @year_totals[:income] * 100).round %>
                <% is_over = expense_pct > 100 %>
                <% bar_pct = [expense_pct, 100].min %>
                <% saved_pct = 100 - bar_pct %>
                <div style="height: 20px; display: flex;" class="text-xs overflow-hidden">
                  <div style="width: <%= bar_pct %>%; background: <%= is_over ? '#e11d48' : '#94a3b8' %>;" class="h-full flex items-center justify-start pl-1">
                    <% if bar_pct > 20 %><span class="text-white"><%= expense_pct %>%</span><% end %>
                  </div>
                  <% if saved_pct > 0 %>
                    <div style="width: <%= saved_pct %>%; background: rgba(148, 163, 184, 0.15);" class="h-full flex items-center justify-end pr-1">
                      <% if saved_pct > 20 %><span class="text-slate-400"><%= saved_pct %>%</span><% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <% end %>

  <!-- Income Categories -->
  <% if @income_category_spending.any? %>
  <div class="<%= ui_card_table_class %>">
    <table class="min-w-full">
      <thead class="<%= ui_table_header_class %>">
        <tr>
            <th class="<%= ui_table_th_class %>">Income</th>
            <th class="<%= ui_table_th_class %> text-right" style="width: 60px;"></th>
            <th class="<%= ui_table_th_class %> text-right" style="width: 120px;">Earned</th>
        </tr>
      </thead>
      <tbody class="border-t-[6px] border-slate-100 dark:border-slate-900">
        <% @income_category_spending.each do |item| %>
          <%
            category = item[:category]
            earned = item[:earned]

            if @selected_month
              tx_path = transactions_path(month: Date.new(@selected_year, @selected_month, 1).strftime("%Y-%m"), category_id: category.id)
            else
              tx_path = transactions_path(start_date: "#{@selected_year}-01-01", end_date: "#{@selected_year}-12-31", category_id: category.id)
            end
          %>
          <tr class="<%= ui_table_row_class %>">
            <td class="<%= ui_table_td_class %>">
              <%= link_to category.name, tx_path, class: "font-medium #{ui_text_class} hover:text-cyan-600 dark:hover:text-cyan-400 no-underline" %>
            </td>
            <td class="<%= ui_table_td_class %> text-right tabular-nums whitespace-nowrap <%= ui_text_muted_class %>">
              <%= item[:pct] %>%
            </td>
            <td class="<%= ui_table_td_class %> text-right tabular-nums whitespace-nowrap <%= ui_text_muted_class %>">
              <%= format_currency(earned) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <% end %>

  <!-- Expense Categories -->
  <div class="<%= ui_card_table_class %>">
    <% if @category_spending.empty? %>
      <div class="p-8 text-center">
        <p class="<%= ui_text_muted_class %>">No spending data for this period.</p>
      </div>
    <% else %>
      <table class="min-w-full">
        <thead class="<%= ui_table_header_class %>">
           <tr>
            <th class="<%= ui_table_th_class %>">Expenses</th>
            <th class="<%= ui_table_th_class %>" style="min-width: 200px;"></th>
            <th class="<%= ui_table_th_class %> text-right pl-0" style="width: 120px;">Budget</th>
            <th class="<%= ui_table_th_class %> text-right" style="width: 60px;"></th>
            <th class="<%= ui_table_th_class %> text-right" style="width: 120px;">Spent</th>
          </tr>
        </thead>
        <tbody class="border-t-[6px] border-slate-100 dark:border-slate-900">
          <% @category_spending.each do |item| %>
            <% 
              category = item[:category]
              spent = item[:spent]
              budget_amount = item[:budget_amount]
              
              # Build link to transactions
              if @selected_month
                tx_path = transactions_path(month: Date.new(@selected_year, @selected_month, 1).strftime("%Y-%m"), category_id: category.id)
              else
                tx_path = transactions_path(start_date: "#{@selected_year}-01-01", end_date: "#{@selected_year}-12-31", category_id: category.id)
              end
              
              # Calculate budget usage percentage if budget exists
              budget_pct = budget_amount && budget_amount > 0 ? (spent / budget_amount * 100).round : nil
              is_over_budget = budget_pct && budget_pct > 100
            %>
            <tr class="<%= ui_table_row_class %>">
              <td class="<%= ui_table_td_class %>">
                <%= link_to category.name, tx_path, class: "font-medium #{ui_text_class} hover:text-cyan-600 dark:hover:text-cyan-400 no-underline" %>
              </td>
              <td class="<%= ui_table_td_class %>">
                <% if budget_pct %>
                  <% bar_pct = [budget_pct, 100].min %>
                  <%= link_to budget_path(item[:budget]), class: "block no-underline" do %>
                    <div style="height: 20px; display: flex;" class="text-xs overflow-hidden hover:opacity-80 transition">
                      <div style="width: <%= bar_pct %>%; background: <%= is_over_budget ? '#e11d48' : '#94a3b8' %>;" class="h-full flex items-center justify-start pl-1">
                        <% if bar_pct > 25 %><span class="text-white"><%= budget_pct %>%</span><% end %>
                      </div>
                      <% if budget_pct <= 100 %>
                        <div style="width: <%= 100 - bar_pct %>%; background: rgba(148, 163, 184, 0.15);" class="h-full"></div>
                      <% end %>
                    </div>
                  <% end %>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">-</span>
                <% end %>
              </td>
              <td class="<%= ui_table_td_class %> text-right <%= ui_text_muted_class %> tabular-nums pl-0">
                <% if budget_amount %>
                  <%= format_currency(budget_amount) %>
                <% else %>
                  <span class="<%= ui_text_subtle_class %>">-</span>
                <% end %>
              </td>
              <td class="<%= ui_table_td_class %> text-right tabular-nums whitespace-nowrap <%= ui_text_muted_class %>">
                <%= item[:pct] %>%
              </td>
              <td class="<%= ui_table_td_class %> text-right tabular-nums whitespace-nowrap <%= is_over_budget ? ui_negative_class + ' font-medium' : ui_text_muted_class %>">
                <%= format_currency(spent) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
