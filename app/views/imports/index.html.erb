<% content_for :title, "Imports" %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Records" %>
    <%= ui_breadcrumb_item "Transactions", transactions_path %>
  <% end %>
<% end %>

<div class="w-full">
  <div class="flex justify-between items-center h-10 mb-6">
    <h1 class="<%= ui_title_class %>">Imports</h1>
    <div class="flex items-center gap-3">
      <%= form_with url: imports_path, method: :get, local: true, class: "flex items-center" do %>
        <%= select_tag :account_id,
          options_for_select(
            [["Account", ""]] + @filter_accounts.map { |a| [a.name, a.id] },
            @filter_account&.id
          ),
          onchange: "this.form.submit()",
          class: "#{ui_input_class} py-1.5 text-sm" %>
      <% end %>
      <%= link_to "New", new_import_path, class: ui_btn_primary_class %>
    </div>
  </div>

  <% if @needs_attention.any? && !@filter_account %>
    <!-- Ready for Review -->
    <div class="<%= ui_card_class %> mb-4" data-controller="collapsible">
      <div class="px-4 py-3 cursor-pointer flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 transition"
           data-action="click->collapsible#toggle">
        <div class="flex items-center gap-2">
          <span data-collapsible-target="icon" class="<%= ui_text_muted_class %> text-xs">&#9654;</span>
          <h2 class="text-sm font-medium <%= ui_text_class %>">Ready for Review</h2>
          <span class="text-xs px-1.5 py-0.5 rounded bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400">
            <%= @needs_attention.size %> import<%= @needs_attention.size == 1 ? '' : 's' %>
          </span>
        </div>
      </div>

      <div data-collapsible-target="content" class="hidden">
        <div class="border-t border-slate-200 dark:border-slate-700">
          <table class="min-w-full">
            <tbody class="<%= ui_card_body_class %>">
              <% @needs_attention.each do |import| %>
                <%= render partial: "imports/import_row", locals: { import: import, compact: true } %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <%# Coverage Analysis Section - only show in default view %>
  <% if @account_coverage.any? && !@filter_account %>
    <div class="<%= ui_card_class %> mb-4" data-controller="collapsible">
      <div class="px-4 py-3 cursor-pointer flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 transition"
           data-action="click->collapsible#toggle">
        <div class="flex items-center gap-2">
          <span data-collapsible-target="icon" class="<%= ui_text_muted_class %> text-xs">&#9654;</span>
          <h2 class="text-sm font-medium <%= ui_text_class %>">Missing Transactions</h2>
          <% gaps_count = @account_coverage.count { |c| !c[:complete?] } %>
          <% if gaps_count > 0 %>
            <span class="text-xs px-1.5 py-0.5 rounded bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400">
              <%= gaps_count %> account<%= gaps_count == 1 ? '' : 's' %> with gaps
            </span>
          <% end %>
        </div>
      </div>

      <div data-collapsible-target="content" class="hidden">
        <div class="border-t border-slate-200 dark:border-slate-700 p-4 space-y-3">
          <% @account_coverage.each do |coverage| %>
            <%= render "shared/coverage_row", coverage: coverage %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# Year Navigation - only show in default view %>
  <% unless @filter_account %>
    <div class="<%= ui_card_class %> mb-4 px-4 py-2">
      <div class="flex items-center justify-between">
        <% prev_year = @current_year - 1 %>
        <% if @available_years.include?(prev_year) %>
          <%= link_to imports_path(year: prev_year), class: "p-1 hover:bg-slate-50 dark:hover:bg-slate-700 transition #{ui_text_muted_class} text-sm" do %>
            &larr; <%= prev_year %>
          <% end %>
        <% else %>
          <span class="p-1 text-transparent text-sm">&larr; <%= prev_year %></span>
        <% end %>

        <span class="font-semibold <%= ui_text_class %>"><%= @current_year %></span>

        <% next_year = @current_year + 1 %>
        <% if @available_years.include?(next_year) %>
          <%= link_to imports_path(year: next_year), class: "p-1 hover:bg-slate-50 dark:hover:bg-slate-700 transition #{ui_text_muted_class} text-sm" do %>
            <%= next_year %> &rarr;
          <% end %>
        <% else %>
          <span class="p-1 text-transparent text-sm"><%= next_year %> &rarr;</span>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @sorted_months.any? || @has_ungrouped %>
    <div class="<%= ui_card_table_class %>">
      <table class="min-w-full">
        <thead class="<%= ui_table_header_class %>">
          <tr>
            <th class="<%= ui_table_th_class %>">File</th>
            <th class="<%= ui_table_th_class %>">Account</th>
            <th class="<%= ui_table_th_class %>">Status</th>
            <th class="<%= ui_table_th_class %>">Transactions</th>
            <th class="<%= ui_table_th_class %>">Imported</th>
            <th class="<%= ui_table_th_class %> text-right w-24"></th>
          </tr>
        </thead>
        <tbody class="<%= ui_card_body_class %>">
          <%# Render each month group %>
          <% @sorted_months.each do |month| %>
            <% month_imports = @imports_by_month[month] %>
            <tr class="<%= ui_table_group_header_class %> <%= ui_table_group_separator_class %>">
              <td colspan="6" class="px-4 py-1.5 text-xs font-medium <%= ui_table_group_text_class %>">
                <%= month.strftime(@filter_account ? "%B %Y" : "%B") %>
                <span class="<%= ui_text_muted_class %> ml-2"><%= month_imports.size %> import<%= month_imports.size == 1 ? '' : 's' %></span>
              </td>
            </tr>
            <% month_imports.each do |import| %>
              <%= render partial: "imports/import_row", locals: { import: import } %>
            <% end %>
          <% end %>

          <%# Render ungrouped imports (pending, failed, or no transactions) %>
          <% if @has_ungrouped %>
            <% ungrouped_imports = @imports_by_month[nil] %>
            <tr class="<%= ui_table_group_header_class %> <%= ui_table_group_separator_class %>">
              <td colspan="6" class="px-4 py-1.5 text-xs font-medium <%= ui_table_group_text_class %>">
                <% if @sorted_months.any? %>
                  Other
                <% else %>
                  Recent
                <% end %>
                <span class="<%= ui_text_muted_class %> ml-2"><%= ungrouped_imports.size %> import<%= ungrouped_imports.size == 1 ? '' : 's' %></span>
              </td>
            </tr>
            <% ungrouped_imports.each do |import| %>
              <%= render partial: "imports/import_row", locals: { import: import } %>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="<%= ui_card_class %> <%= ui_empty_class %>">
      <% if @filter_account %>
        <p class="<%= ui_text_muted_class %> mb-4">No imports for <%= @filter_account.name %>.</p>
      <% else %>
        <p class="<%= ui_text_muted_class %> mb-4">No imports for <%= @current_year %>.</p>
      <% end %>
      <%= link_to "Upload a statement", new_import_path, class: ui_link_class %>
    </div>
  <% end %>
</div>
