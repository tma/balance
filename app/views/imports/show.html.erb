<% content_for :title, "Import - #{@import.original_filename}" %>

<div class="w-full">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <div class="flex items-center gap-3 mb-1">
        <h1 class="text-2xl font-bold text-slate-800"><%= @import.original_filename %></h1>
        <% case @import.status %>
        <% when "pending" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">Pending</span>
        <% when "processing" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-700">Processing</span>
        <% when "completed" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">Ready</span>
        <% when "failed" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-rose-100 text-rose-700">Failed</span>
        <% end %>
      </div>
      <p class="text-sm text-slate-500">
        Importing to <span class="font-medium text-slate-700"><%= @import.account.name %></span>
        <span class="text-slate-300 mx-1">&middot;</span>
        <%= time_ago_in_words(@import.created_at) %> ago
      </p>
    </div>
    <div class="flex items-center gap-2">
      <%= link_to new_import_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm" do %>
        New Import
      <% end %>
      <%= link_to imports_path, class: "rounded-lg px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 font-medium transition text-sm" do %>
        All Imports
      <% end %>
    </div>
  </div>

  <% if @import.pending? || @import.processing? %>
    <!-- Processing State -->
    <div class="bg-white rounded-xl border border-slate-200 p-8 md:p-12">
      <div class="max-w-md mx-auto text-center">
        <!-- Animated spinner -->
        <div class="relative mx-auto w-16 h-16 mb-6">
          <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
          <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-cyan-500 animate-spin"></div>
          <% if @import.processing? %>
            <div class="absolute inset-2 rounded-full border-4 border-transparent border-t-cyan-300 animate-spin" style="animation-direction: reverse; animation-duration: 1.5s;"></div>
          <% end %>
        </div>
        
        <h2 class="text-xl font-semibold text-slate-800 mb-2">
          <%= @import.pending? ? "Waiting in Queue" : "Analyzing Your Statement" %>
        </h2>
        
        <p class="text-slate-500 mb-6">
          <% if @import.processing? %>
            AI is extracting transactions from your bank statement. This typically takes 30-60 seconds depending on the file size.
          <% else %>
            Your import is queued and will begin processing shortly.
          <% end %>
        </p>

        <!-- Progress indicators -->
        <div class="flex items-center justify-center gap-6 text-sm">
          <div class="flex items-center gap-2 <%= @import.pending? || @import.processing? ? 'text-cyan-600' : 'text-slate-400' %>">
            <div class="w-2 h-2 rounded-full <%= @import.pending? ? 'bg-cyan-500 animate-pulse' : 'bg-emerald-500' %>"></div>
            <span>Upload</span>
          </div>
          <div class="w-8 h-px bg-slate-200"></div>
          <div class="flex items-center gap-2 <%= @import.processing? ? 'text-cyan-600' : 'text-slate-400' %>">
            <div class="w-2 h-2 rounded-full <%= @import.processing? ? 'bg-cyan-500 animate-pulse' : 'bg-slate-300' %>"></div>
            <span>Extract</span>
          </div>
          <div class="w-8 h-px bg-slate-200"></div>
          <div class="flex items-center gap-2 text-slate-400">
            <div class="w-2 h-2 rounded-full bg-slate-300"></div>
            <span>Review</span>
          </div>
        </div>
        
        <p class="text-xs text-slate-400 mt-6">This page refreshes automatically</p>
      </div>
    </div>

  <% elsif @import.failed? %>
    <!-- Failed State -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
      <div class="bg-rose-50 border-b border-rose-100 px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <div>
            <h2 class="font-semibold text-rose-800">Import Failed</h2>
            <p class="text-sm text-rose-600">Unable to process your file</p>
          </div>
        </div>
      </div>
      
      <div class="p-6">
        <div class="bg-slate-50 rounded-lg p-4 mb-6">
          <p class="text-sm font-medium text-slate-700 mb-1">Error Details</p>
          <p class="text-sm text-slate-600 font-mono"><%= @import.error_message %></p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3">
          <%= link_to new_import_path, class: "inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Try Different File
          <% end %>
          <%= link_to new_transaction_path(account_id: @import.account_id), class: "inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Manually
          <% end %>
        </div>
      </div>
    </div>

  <% elsif @import.completed? && @transactions.any? %>
    <!-- Summary Stats -->
    <% 
      income_txns = @transactions.select { |t| t[:transaction_type] == 'income' }
      expense_txns = @transactions.select { |t| t[:transaction_type] == 'expense' }
      duplicate_count = @transactions.count { |t| t[:is_duplicate] }
      total_income = income_txns.sum { |t| t[:amount].to_f }
      total_expense = expense_txns.sum { |t| t[:amount].to_f }
    %>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Transactions</p>
        <p class="text-2xl font-semibold text-slate-800"><%= @transactions.size %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Income</p>
        <p class="text-2xl font-semibold text-emerald-500">+<%= number_with_delimiter(total_income.round(2), delimiter: "'") %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Expenses</p>
        <p class="text-2xl font-semibold text-rose-400">-<%= number_with_delimiter(total_expense.round(2), delimiter: "'") %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Duplicates</p>
        <p class="text-2xl font-semibold <%= duplicate_count > 0 ? 'text-amber-500' : 'text-slate-400' %>"><%= duplicate_count %></p>
      </div>
    </div>

    <!-- Review Transactions -->
    <%= form_with url: confirm_import_path(@import), method: :post do |form| %>
      <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-6">
        <!-- Table Header -->
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="flex items-center gap-3">
            <span class="font-medium text-slate-700">Review & Import</span>
            <% if @import.duration %>
              <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded">Processed in <%= @import.duration.round(1) %>s</span>
            <% end %>
          </div>
          <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer hover:text-slate-800">
            <input type="checkbox" id="select-all" checked class="rounded border-slate-300 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0">
            <span>Select all non-duplicates</span>
          </label>
        </div>

        <!-- Transactions Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-12"></th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-28">Type</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-40">Category</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-32">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <% @transactions.each_with_index do |txn, index| %>
                <tr class="<%= txn[:is_duplicate] ? 'bg-amber-50/50' : 'hover:bg-slate-50' %> transition-colors">
                  <td class="px-4 py-3">
                    <input type="checkbox" 
                           name="transactions[<%= index %>][selected]" 
                           value="1"
                           <%= txn[:is_duplicate] ? '' : 'checked' %>
                           class="transaction-checkbox rounded border-slate-300 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0">
                    <%= hidden_field_tag "transactions[#{index}][date]", txn[:date] %>
                    <%= hidden_field_tag "transactions[#{index}][description]", txn[:description] %>
                    <%= hidden_field_tag "transactions[#{index}][amount]", txn[:amount] %>
                    <%= hidden_field_tag "transactions[#{index}][duplicate_hash]", txn[:duplicate_hash] %>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">
                    <%= txn[:date].is_a?(Date) ? txn[:date].strftime("%b %d, %Y") : txn[:date] %>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-800">
                    <div class="flex items-center gap-2">
                      <span class="<%= txn[:is_duplicate] ? 'text-slate-500' : '' %>"><%= txn[:description] %></span>
                      <% if txn[:is_duplicate] %>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700">
                          Duplicate
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-4 py-3">
                    <select name="transactions[<%= index %>][transaction_type]" 
                            class="w-full text-sm rounded-lg border-slate-200 bg-slate-50 focus:border-cyan-500 focus:ring-cyan-500 py-1.5">
                      <option value="expense" <%= txn[:transaction_type] == 'expense' ? 'selected' : '' %>>Expense</option>
                      <option value="income" <%= txn[:transaction_type] == 'income' ? 'selected' : '' %>>Income</option>
                    </select>
                  </td>
                  <td class="px-4 py-3">
                    <select name="transactions[<%= index %>][category_id]" 
                            class="w-full text-sm rounded-lg border-slate-200 bg-slate-50 focus:border-cyan-500 focus:ring-cyan-500 py-1.5">
                      <optgroup label="Expense">
                        <% @expense_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name.titleize %></option>
                        <% end %>
                      </optgroup>
                      <optgroup label="Income">
                        <% @income_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name.titleize %></option>
                        <% end %>
                      </optgroup>
                    </select>
                  </td>
                  <td class="px-4 py-3 text-sm text-right whitespace-nowrap font-medium <%= txn[:transaction_type] == 'income' ? 'text-emerald-600' : 'text-slate-700' %>">
                    <%= txn[:transaction_type] == 'income' ? '+' : '' %><%= number_with_delimiter(txn[:amount], delimiter: "'") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500">
          <span class="font-medium text-slate-700" id="selected-count"><%= @transactions.count { |t| !t[:is_duplicate] } %></span> transactions selected for import
        </p>
        <div class="flex items-center gap-3">
          <%= link_to "Cancel", imports_path, class: "rounded-lg px-4 py-2 text-slate-600 hover:text-slate-800 font-medium transition text-sm" %>
          <%= form.submit "Import Selected Transactions", class: "rounded-lg px-5 py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white font-medium cursor-pointer transition text-sm" %>
        </div>
      </div>
    <% end %>

  <% elsif @import.completed? && @transactions.empty? %>
    <!-- No Transactions Found -->
    <div class="bg-white rounded-xl border border-slate-200 p-8 md:p-12">
      <div class="max-w-md mx-auto text-center">
        <div class="w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-6">
          <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        
        <h2 class="text-xl font-semibold text-slate-800 mb-2">No Transactions Found</h2>
        <p class="text-slate-500 mb-6">
          The AI couldn't extract any transactions from this file. This might happen if the file format is unusual or the content is image-based.
        </p>
        
        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
          <%= link_to new_import_path, class: "inline-flex items-center gap-2 rounded-lg px-4 py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Try Different File
          <% end %>
          <%= link_to new_transaction_path(account_id: @import.account_id), class: "inline-flex items-center gap-2 rounded-lg px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Manually
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if @refresh %>
<script>
  setTimeout(function() {
    window.location.reload();
  }, 3000);
</script>
<% end %>

<script>
  // Select all / deselect all functionality
  const selectAllCheckbox = document.getElementById('select-all');
  const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
  const selectedCountEl = document.getElementById('selected-count');
  
  function updateSelectedCount() {
    if (selectedCountEl) {
      const count = document.querySelectorAll('.transaction-checkbox:checked').length;
      selectedCountEl.textContent = count;
    }
  }
  
  selectAllCheckbox?.addEventListener('change', function(e) {
    transactionCheckboxes.forEach(cb => {
      const row = cb.closest('tr');
      if (!row.classList.contains('bg-amber-50/50')) {
        cb.checked = e.target.checked;
      }
    });
    updateSelectedCount();
  });
  
  transactionCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
  });
</script>
