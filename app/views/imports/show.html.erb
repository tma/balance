<% content_for :title, "Import - #{@import.original_filename}" %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Records" %>
    <%= ui_breadcrumb_item "Transactions", transactions_path %>
    <%= ui_breadcrumb_item "Imports", imports_path %>
  <% end %>
<% end %>

<div class="w-full">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="<%= ui_title_class %> mb-1"><%= @import.original_filename %></h1>
      <div class="flex items-center gap-2">
        <%= render "imports/status_badge", import: @import %>
        <span class="<%= ui_text_subtle_class %>">&middot;</span>
        <span class="text-sm <%= ui_text_muted_class %>"><%= time_ago_in_words(@import.created_at) %> ago</span>
        <span class="<%= ui_text_subtle_class %>">&middot;</span>
        <span class="text-sm <%= ui_text_muted_class %>">
          <%= link_to edit_account_path(@import.account), class: "font-medium #{ui_text_class} #{ui_link_class}" do %><%= @import.account.name %><% end %> <span class="px-1.5 py-0.5 text-xs bg-sky-50 dark:bg-sky-900/50 text-sky-600 dark:text-sky-300"><%= @import.account.currency %></span>
        </span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <% if @import.completed? || @import.failed? %>
        <%= button_to reprocess_import_path(@import), method: :post, class: "#{ui_btn_secondary_class} text-sm flex items-center gap-2", form: { data: { turbo_confirm: "Reprocess this import? Current results will be replaced." } } do %>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Reprocess
        <% end %>
      <% end %>
      <%= link_to imports_path, class: "#{ui_btn_secondary_class} text-sm" do %>
        Imports
      <% end %>
    </div>
  </div>

  <% if @import.pending? || @import.processing? %>
    <!-- Processing State with Turbo Stream updates -->
    <%= turbo_stream_from @import %>
    
    <div class="<%= ui_card_class %> p-8 md:p-12" data-controller="import-status">
      <div class="max-w-md mx-auto text-center">
        <!-- Animated spinner (kept outside stream target to stay smooth) -->
        <div class="relative mx-auto w-16 h-16 mb-6">
          <div class="absolute inset-0 border-4 border-slate-100 dark:border-slate-700"></div>
          <div class="absolute inset-0 border-4 border-transparent border-t-cyan-500 animate-spin"></div>
          <div class="absolute inset-2 border-4 border-transparent border-t-cyan-300 animate-spin" style="animation-direction: reverse; animation-duration: 1.5s;"></div>
        </div>
        
        <!-- Turbo Stream target for live updates -->
        <%= render partial: "imports/status", locals: { import: @import } %>
      </div>
    </div>

  <% elsif @import.failed? %>
    <!-- Failed State -->
    <div class="<%= ui_card_table_class %>">
      <div class="bg-rose-50 dark:bg-rose-900/30 border-b border-rose-100 dark:border-rose-800 px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-10 h-10 bg-rose-100 dark:bg-rose-900/50 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-500 dark:text-rose-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <div>
            <h2 class="font-semibold text-rose-800 dark:text-rose-300">Import Failed</h2>
            <p class="text-sm text-rose-600 dark:text-rose-400">Unable to process the file</p>
          </div>
        </div>
      </div>
      
      <div class="p-6">
        <div class="bg-slate-50 dark:bg-slate-900 p-4 mb-6">
          <p class="text-sm font-medium <%= ui_text_class %> mb-1">Error Details</p>
          <p class="text-sm <%= ui_text_muted_class %> font-mono"><%= @import.error_message %></p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3">
          <%= button_to reprocess_import_path(@import), method: :post, class: "inline-flex items-center justify-center gap-2 #{ui_btn_primary_class} text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Reprocess
          <% end %>
          <%= link_to new_import_path, class: "inline-flex items-center justify-center gap-2 #{ui_btn_secondary_class} text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Try Different File
          <% end %>
          <%= link_to new_transaction_path(account_id: @import.account_id), class: "inline-flex items-center justify-center gap-2 #{ui_btn_secondary_class} text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Manually
          <% end %>
          <%= button_to import_path(@import), method: :delete, class: "inline-flex items-center justify-center gap-2 px-4 py-2 text-rose-500 dark:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/30 font-medium transition text-sm", form: { data: { turbo_confirm: "Delete this failed import?" } } do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
          <% end %>
        </div>
      </div>
    </div>

  <% elsif @import.completed? && @transactions.any? %>
    <!-- Summary Stats -->
    <% 
      selectable_transactions = @transactions.reject { |t| t[:is_ignored] }
      income_txns = selectable_transactions.select { |t| t[:transaction_type] == 'income' }
      expense_txns = selectable_transactions.select { |t| t[:transaction_type] == 'expense' }
      duplicate_count = selectable_transactions.count { |t| t[:is_duplicate] }
      total_income = income_txns.sum { |t| t[:amount].to_f }
      total_expense = expense_txns.sum { |t| t[:amount].to_f }
    %>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Transactions</p>
        <p class="text-2xl font-semibold <%= ui_text_class %>"><%= @transactions.size %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Income</p>
        <p class="text-2xl font-semibold <%= ui_positive_class %>">+<%= format_amount(total_income) %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Expenses</p>
        <p class="text-2xl font-semibold <%= ui_negative_class %>">-<%= format_amount(total_expense) %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Duplicates</p>
        <p class="text-2xl font-semibold <%= duplicate_count > 0 ? 'text-amber-500 dark:text-amber-400' : ui_text_subtle_class %>"><%= duplicate_count %></p>
      </div>
    </div>

    <!-- Review Transactions -->
    <%= form_with url: confirm_import_path(@import), method: :post, data: { controller: "import-table" } do |form| %>
      <div class="<%= ui_card_table_class %> mb-6">
        <!-- Table Header -->
        <div class="px-4 py-3 <%= ui_table_header_class %> flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="flex items-center gap-3">
            <span class="font-medium <%= ui_text_class %>">Review & Import</span>
            <% if @import.duration %>
              <span class="text-xs <%= ui_text_subtle_class %> bg-slate-100 dark:bg-slate-700 px-2 py-0.5">Processed in <%= @import.duration.round(1) %>s</span>
            <% end %>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-xs <%= ui_text_subtle_class %> hidden sm:inline">
              <kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 <%= ui_text_muted_class %>">j</kbd>/<kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 <%= ui_text_muted_class %>">k</kbd> navigate
              <kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 <%= ui_text_muted_class %> ml-2">space</kbd> toggle
              <kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 <%= ui_text_muted_class %> ml-2">t</kbd> type
              <kbd class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 <%= ui_text_muted_class %> ml-2">c</kbd> category
            </span>
          <label class="flex items-center gap-2 text-sm <%= ui_text_muted_class %> cursor-pointer hover:text-slate-700 dark:hover:text-slate-300">
              <input type="checkbox" 
                     checked 
                     class="<%= ui_checkbox_class %>"
                     data-import-table-target="selectAll"
                     data-action="change->import-table#selectAllChanged">
              <span>Select all</span>
            </label>
          </div>
        </div>

        <!-- Transactions Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="<%= ui_table_header_class %>">
              <tr>
                <th class="<%= ui_table_th_class %> w-12"></th>
                <th class="<%= ui_table_th_class %>">Date</th>
                <th class="<%= ui_table_th_class %>">Description</th>
                <th class="<%= ui_table_th_class %> w-28">Type</th>
                <th class="<%= ui_table_th_class %> w-40">Category</th>
                <th class="<%= ui_table_th_class %> text-right w-32">Amount</th>
              </tr>
            </thead>
            <tbody class="<%= ui_card_body_class %>">
              <% @transactions.each_with_index do |txn, index| %>
                <% 
                  row_class = if txn[:is_ignored]
                    'bg-slate-100/50 dark:bg-slate-800/50 opacity-60 ignored-row border-b border-slate-100 dark:border-slate-700/50'
                  elsif txn[:is_duplicate]
                    'opacity-60 duplicate-row border-b border-slate-100 dark:border-slate-700/50'
                  else
                    ui_table_row_class
                  end
                %>
                <tr class="<%= row_class %> cursor-pointer"
                    data-import-table-target="row"
                    data-action="click->import-table#rowClicked">
                  <td class="px-4 py-3">
                    <input type="checkbox" 
                           name="transactions[<%= index %>][selected]" 
                           value="1"
                           <%= (txn.key?(:selected) ? txn[:selected] : !(txn[:is_duplicate] || txn[:is_ignored])) ? 'checked' : '' %>
                           class="transaction-checkbox <%= ui_checkbox_class %>"
                           data-action="change->import-table#checkboxChanged">
                    <%= hidden_field_tag "transactions[#{index}][description]", txn[:description] %>
                    <%= hidden_field_tag "transactions[#{index}][amount]", txn[:amount] %>
                    <%= hidden_field_tag "transactions[#{index}][duplicate_hash]", txn[:duplicate_hash] %>
                    <%= hidden_field_tag "transactions[#{index}][is_duplicate]", txn[:is_duplicate] ? "1" : "0" %>
                    <%= hidden_field_tag "transactions[#{index}][is_ignored]", txn[:is_ignored] ? "1" : "0" %>
                  </td>
                  <td class="px-4 py-3">
                    <input type="date" 
                           name="transactions[<%= index %>][date]" 
                           value="<%= txn[:date].is_a?(Date) ? txn[:date].strftime('%Y-%m-%d') : txn[:date] %>"
                           class="text-sm <%= ui_input_sm_class %> py-1.5">
                  </td>
                  <td class="px-4 py-3 text-sm <%= ui_text_class %>">
                    <div class="flex items-center gap-2">
                      <span class="<%= (txn[:is_duplicate] || txn[:is_ignored]) ? ui_text_muted_class : '' %>"><%= txn[:description] %></span>
                      <% if txn[:is_ignored] %>
                        <span class="<%= ui_badge_class %>">Ignored</span>
                      <% end %>
                      <% if txn[:is_duplicate] %>
                        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300">Duplicate</span>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-4 py-3">
                    <select name="transactions[<%= index %>][transaction_type]" 
                            class="transaction-type w-full text-sm <%= ui_input_sm_class %> py-1.5">
                      <option value="expense" <%= txn[:transaction_type] == 'expense' ? 'selected' : '' %>>Expense</option>
                      <option value="income" <%= txn[:transaction_type] == 'income' ? 'selected' : '' %>>Income</option>
                    </select>
                  </td>
                  <td class="px-4 py-3">
                    <select name="transactions[<%= index %>][category_id]" 
                            class="transaction-category w-full text-sm <%= ui_input_sm_class %> py-1.5"
                            data-action="change->import-table#categoryChanged">
                      <option value="" <%= txn[:category_id].present? ? '' : 'selected' %>></option>
                      <optgroup label="Expense">
                        <% @expense_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                        <% end %>
                      </optgroup>
                      <optgroup label="Income">
                        <% @income_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                        <% end %>
                      </optgroup>
                    </select>
                  </td>
                  <td class="px-4 py-3 text-sm text-right whitespace-nowrap font-medium <%= ui_text_class %>">
                    <%= txn[:transaction_type] == 'expense' ? '-' : '' %><%= format_amount(txn[:amount]) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4 <%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %>">
          <span class="font-medium <%= ui_text_class %>" data-import-table-target="selectedCount"><%= @transactions.count { |t| t.key?(:selected) ? t[:selected] : (!t[:is_duplicate] && !t[:is_ignored]) } %></span> transactions selected
        </p>
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2 text-sm <%= ui_text_muted_class %> cursor-pointer hover:text-slate-700 dark:hover:text-slate-300">
            <input type="checkbox" 
                   name="mark_as_done" 
                   value="1"
                   class="<%= ui_checkbox_class %>">
            <span>Mark as done</span>
          </label>
          <%= form.submit "Import", class: "#{ui_btn_primary_class} cursor-pointer text-sm" %>
          <div class="w-4"></div>
          <%= form.button "Save", formaction: save_import_path(@import), formmethod: "patch", class: "#{ui_btn_secondary_class} cursor-pointer text-sm" %>
        </div>
      </div>
    <% end %>

  <% elsif @import.completed? && @transactions.empty? %>
    <!-- No Transactions Found -->
    <div class="<%= ui_card_class %> p-8 md:p-12">
      <div class="max-w-md mx-auto text-center">
        <div class="w-16 h-16 bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center mx-auto mb-6">
          <svg class="w-8 h-8 text-amber-500 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        
        <h2 class="text-xl font-semibold <%= ui_text_class %> mb-2">No Transactions Found</h2>
        <p class="<%= ui_text_muted_class %> mb-6">
          The AI couldn't extract any transactions from this file. This might happen if the file format is unusual or the content is image-based.
        </p>
        
        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
          <%= link_to new_import_path, class: "inline-flex items-center gap-2 #{ui_btn_primary_class} text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Try Different File
          <% end %>
          <%= link_to new_transaction_path(account_id: @import.account_id), class: "inline-flex items-center gap-2 #{ui_btn_secondary_class} text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Manually
          <% end %>
        </div>
      </div>
    </div>

  <% elsif @import.done? %>
    <!-- Done State - Read-only view of imported transactions -->
    <% 
      income_txns = @imported_transactions.select { |t| t.transaction_type == 'income' }
      expense_txns = @imported_transactions.select { |t| t.transaction_type == 'expense' }
      total_income = income_txns.sum(&:amount)
      total_expense = expense_txns.sum(&:amount)
    %>
    
    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Imported</p>
        <p class="text-2xl font-semibold <%= ui_text_class %>"><%= @imported_transactions.size %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Income</p>
        <p class="text-2xl font-semibold <%= ui_positive_class %>">+<%= format_amount(total_income) %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %> mb-1">Expenses</p>
        <p class="text-2xl font-semibold <%= ui_negative_class %>">-<%= format_amount(total_expense) %></p>
      </div>
    </div>

    <!-- Imported Transactions Table -->
    <div class="<%= ui_card_table_class %> mb-6">
      <div class="px-4 py-3 <%= ui_table_header_class %> flex items-center justify-between">
        <span class="font-medium <%= ui_text_class %>">Imported Transactions</span>
        <% if @import.completed_at %>
          <span class="text-xs <%= ui_text_subtle_class %>">Completed <%= time_ago_in_words(@import.completed_at) %> ago</span>
        <% end %>
      </div>

      <% if @imported_transactions.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="<%= ui_table_header_class %>">
              <tr>
                <th class="<%= ui_table_th_class %>">Date</th>
                <th class="<%= ui_table_th_class %>">Description</th>
                <th class="<%= ui_table_th_class %>">Category</th>
                <th class="<%= ui_table_th_class %> text-right">Amount</th>
              </tr>
            </thead>
            <tbody class="<%= ui_card_body_class %>">
              <% @imported_transactions.each do |txn| %>
                <tr class="<%= ui_table_row_class %>">
                  <td class="<%= ui_table_td_class %> <%= ui_text_muted_class %> whitespace-nowrap">
                    <%= txn.date.strftime("%b %d, %Y") %>
                  </td>
                  <td class="<%= ui_table_td_class %> <%= ui_text_class %>">
                    <%= link_to txn.description, edit_transaction_path(txn), class: ui_link_class %>
                  </td>
                  <td class="<%= ui_table_td_class %> <%= ui_text_muted_class %>">
                    <%= txn.category&.name || "â€”" %>
                  </td>
                  <td class="<%= ui_table_td_class %> text-right whitespace-nowrap font-medium <%= ui_text_class %>">
                    <%= txn.transaction_type == 'expense' ? '-' : '' %><%= format_amount(txn.amount) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="<%= ui_empty_class %> <%= ui_text_muted_class %>">
          No transactions were imported from this file.
        </div>
      <% end %>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between <%= ui_card_class %> p-4">
      <p class="text-sm <%= ui_text_muted_class %>">
        This import has been reviewed and completed.
      </p>
      <div class="flex items-center gap-3">
        <%= link_to transactions_path, class: "px-4 py-2 #{ui_text_muted_class} hover:#{ui_text_class} font-medium transition text-sm" do %>
          View All Transactions
        <% end %>
        <%= button_to import_path(@import), method: :delete, class: "px-4 py-2 text-rose-500 dark:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-900/30 font-medium transition text-sm", form: { data: { turbo_confirm: "Delete this import? The imported transactions will remain." } } do %>
          Delete Import
        <% end %>
      </div>
    </div>
  <% end %>
</div>
