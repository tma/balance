<% content_for :title, "Import - #{@import.original_filename}" %>

<div class="w-full">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold text-slate-800 mb-1"><%= @import.original_filename %></h1>
      <div class="flex items-center gap-2">
        <% case @import.status %>
        <% when "pending" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">Pending</span>
        <% when "processing" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-700">Processing</span>
        <% when "completed" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">Ready</span>
        <% when "failed" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-rose-100 text-rose-700">Failed</span>
        <% when "done" %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">Done</span>
        <% end %>
        <span class="text-slate-300">&middot;</span>
        <span class="text-sm text-slate-500"><%= time_ago_in_words(@import.created_at) %> ago</span>
        <span class="text-slate-300">&middot;</span>
        <span class="text-sm text-slate-500">
          <%= link_to @import.account.name, edit_account_path(@import.account), class: "font-medium text-slate-700 hover:text-cyan-600" %>
        </span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <% if @import.completed? || @import.failed? %>
        <%= button_to reprocess_import_path(@import), method: :post, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm flex items-center gap-2", form: { data: { turbo_confirm: "Reprocess this import? Current results will be replaced." } } do %>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Reprocess
        <% end %>
      <% end %>
      <%= link_to imports_path, class: "rounded-lg px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 font-medium transition text-sm" do %>
        Imports
      <% end %>
    </div>
  </div>

  <% if @import.pending? || @import.processing? %>
    <!-- Processing State with Turbo Frame polling -->
    <div class="bg-white rounded-xl border border-slate-200 p-8 md:p-12">
      <div class="max-w-md mx-auto text-center">
        <!-- Animated spinner (kept outside polling to stay smooth) -->
        <div class="relative mx-auto w-16 h-16 mb-6">
          <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
          <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-cyan-500 animate-spin"></div>
          <div class="absolute inset-2 rounded-full border-4 border-transparent border-t-cyan-300 animate-spin" style="animation-direction: reverse; animation-duration: 1.5s;"></div>
        </div>
        
        <!-- Polled content (text and progress bar only) -->
        <div id="import-status" 
             data-controller="poll" 
             data-poll-url-value="<%= status_import_path(@import) %>"
             data-poll-interval-value="2000">
          <%= render partial: "imports/status", locals: { import: @import } %>
        </div>
      </div>
    </div>

  <% elsif @import.failed? %>
    <!-- Failed State -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
      <div class="bg-rose-50 border-b border-rose-100 px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <div>
            <h2 class="font-semibold text-rose-800">Import Failed</h2>
            <p class="text-sm text-rose-600">Unable to process the file</p>
          </div>
        </div>
      </div>
      
      <div class="p-6">
        <div class="bg-slate-50 rounded-lg p-4 mb-6">
          <p class="text-sm font-medium text-slate-700 mb-1">Error Details</p>
          <p class="text-sm text-slate-600 font-mono"><%= @import.error_message %></p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3">
          <%= button_to reprocess_import_path(@import), method: :post, class: "inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Reprocess
          <% end %>
          <%= link_to new_import_path, class: "inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Try Different File
          <% end %>
          <%= link_to new_transaction_path(account_id: @import.account_id), class: "inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Manually
          <% end %>
          <%= button_to import_path(@import), method: :delete, class: "inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-rose-500 hover:bg-rose-50 font-medium transition text-sm", form: { data: { turbo_confirm: "Delete this failed import?" } } do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
          <% end %>
        </div>
      </div>
    </div>

  <% elsif @import.completed? && @transactions.any? %>
    <!-- Summary Stats -->
    <% 
      income_txns = @transactions.select { |t| t[:transaction_type] == 'income' }
      expense_txns = @transactions.select { |t| t[:transaction_type] == 'expense' }
      duplicate_count = @transactions.count { |t| t[:is_duplicate] }
      total_income = income_txns.sum { |t| t[:amount].to_f }
      total_expense = expense_txns.sum { |t| t[:amount].to_f }
    %>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Transactions</p>
        <p class="text-2xl font-semibold text-slate-800"><%= @transactions.size %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Income</p>
        <p class="text-2xl font-semibold text-emerald-500">+<%= format_amount(total_income) %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Expenses</p>
        <p class="text-2xl font-semibold text-rose-400">-<%= format_amount(total_expense) %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Duplicates</p>
        <p class="text-2xl font-semibold <%= duplicate_count > 0 ? 'text-amber-500' : 'text-slate-400' %>"><%= duplicate_count %></p>
      </div>
    </div>

    <!-- Review Transactions -->
    <%= form_with url: confirm_import_path(@import), method: :post, data: { controller: "import-table" } do |form| %>
      <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-6">
        <!-- Table Header -->
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="flex items-center gap-3">
            <span class="font-medium text-slate-700">Review & Import</span>
            <% if @import.duration %>
              <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded">Processed in <%= @import.duration.round(1) %>s</span>
            <% end %>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-xs text-slate-400 hidden sm:inline">
              <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-slate-500">j</kbd>/<kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-slate-500">k</kbd> navigate
              <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-slate-500 ml-2">space</kbd> toggle
              <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-slate-500 ml-2">t</kbd> type
              <kbd class="px-1.5 py-0.5 bg-slate-100 rounded text-slate-500 ml-2">c</kbd> category
            </span>
            <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer hover:text-slate-800">
              <input type="checkbox" 
                     checked 
                     class="rounded border-slate-300 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0"
                     data-import-table-target="selectAll"
                     data-action="change->import-table#selectAllChanged">
              <span>Select all</span>
            </label>
          </div>
        </div>

        <!-- Transactions Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-12"></th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-28">Type</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-40">Category</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-32">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <% @transactions.each_with_index do |txn, index| %>
                <tr class="<%= txn[:is_duplicate] ? 'bg-amber-50/50 duplicate-row' : 'hover:bg-slate-50' %> transition-colors cursor-pointer"
                    data-import-table-target="row"
                    data-action="click->import-table#rowClicked">
                  <td class="px-4 py-3">
                    <input type="checkbox" 
                           name="transactions[<%= index %>][selected]" 
                           value="1"
                           <%= txn[:is_duplicate] ? '' : 'checked' %>
                           class="transaction-checkbox rounded border-slate-300 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0"
                           data-action="change->import-table#checkboxChanged">
                    <%= hidden_field_tag "transactions[#{index}][description]", txn[:description] %>
                    <%= hidden_field_tag "transactions[#{index}][amount]", txn[:amount] %>
                    <%= hidden_field_tag "transactions[#{index}][duplicate_hash]", txn[:duplicate_hash] %>
                  </td>
                  <td class="px-4 py-3">
                    <input type="date" 
                           name="transactions[<%= index %>][date]" 
                           value="<%= txn[:date].is_a?(Date) ? txn[:date].strftime('%Y-%m-%d') : txn[:date] %>"
                           class="text-sm rounded-lg border-slate-200 bg-slate-50 focus:border-cyan-500 focus:ring-cyan-500 py-1.5">
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-800">
                    <div class="flex items-center gap-2">
                      <span class="<%= txn[:is_duplicate] ? 'text-slate-500' : '' %>"><%= txn[:description] %></span>
                      <% if txn[:is_duplicate] %>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700">
                          Duplicate
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-4 py-3">
                    <select name="transactions[<%= index %>][transaction_type]" 
                            class="transaction-type w-full text-sm rounded-lg border-slate-200 bg-slate-50 focus:border-cyan-500 focus:ring-cyan-500 py-1.5">
                      <option value="expense" <%= txn[:transaction_type] == 'expense' ? 'selected' : '' %>>Expense</option>
                      <option value="income" <%= txn[:transaction_type] == 'income' ? 'selected' : '' %>>Income</option>
                    </select>
                  </td>
                  <td class="px-4 py-3">
                    <select name="transactions[<%= index %>][category_id]" 
                            required
                            class="transaction-category w-full text-sm rounded-lg border-slate-200 bg-slate-50 focus:border-cyan-500 focus:ring-cyan-500 py-1.5">
                      <option value="" disabled <%= txn[:category_id].present? ? '' : 'selected' %>></option>
                      <optgroup label="Expense">
                        <% @expense_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                        <% end %>
                      </optgroup>
                      <optgroup label="Income">
                        <% @income_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                        <% end %>
                      </optgroup>
                    </select>
                  </td>
                  <td class="px-4 py-3 text-sm text-right whitespace-nowrap font-medium text-slate-700">
                    <%= txn[:transaction_type] == 'expense' ? '-' : '' %><%= format_amount(txn[:amount]) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-white rounded-xl border border-slate-200 p-4">
        <div class="flex items-center gap-4">
          <p class="text-sm text-slate-500">
            <span class="font-medium text-slate-700" data-import-table-target="selectedCount"><%= @transactions.count { |t| !t[:is_duplicate] } %></span> transactions selected
          </p>
          <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer hover:text-slate-800">
            <input type="checkbox" 
                   name="mark_as_done" 
                   value="1"
                   class="rounded border-slate-300 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0">
            <span>Mark as done</span>
          </label>
        </div>
        <div class="flex items-center gap-3">
          <%= link_to "Cancel", new_import_path, class: "rounded-lg px-4 py-2 text-slate-600 hover:text-slate-800 font-medium transition text-sm" %>
          <%= form.submit "Import", class: "rounded-lg px-5 py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white font-medium cursor-pointer transition text-sm" %>
        </div>
      </div>
    <% end %>

  <% elsif @import.completed? && @transactions.empty? %>
    <!-- No Transactions Found -->
    <div class="bg-white rounded-xl border border-slate-200 p-8 md:p-12">
      <div class="max-w-md mx-auto text-center">
        <div class="w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-6">
          <svg class="w-8 h-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        
        <h2 class="text-xl font-semibold text-slate-800 mb-2">No Transactions Found</h2>
        <p class="text-slate-500 mb-6">
          The AI couldn't extract any transactions from this file. This might happen if the file format is unusual or the content is image-based.
        </p>
        
        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
          <%= link_to new_import_path, class: "inline-flex items-center gap-2 rounded-lg px-4 py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Try Different File
          <% end %>
          <%= link_to new_transaction_path(account_id: @import.account_id), class: "inline-flex items-center gap-2 rounded-lg px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition text-sm" do %>
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Manually
          <% end %>
        </div>
      </div>
    </div>

  <% elsif @import.done? %>
    <!-- Done State - Read-only view of imported transactions -->
    <% 
      income_txns = @imported_transactions.select { |t| t.transaction_type == 'income' }
      expense_txns = @imported_transactions.select { |t| t.transaction_type == 'expense' }
      total_income = income_txns.sum(&:amount)
      total_expense = expense_txns.sum(&:amount)
    %>
    
    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Imported</p>
        <p class="text-2xl font-semibold text-slate-800"><%= @imported_transactions.size %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Income</p>
        <p class="text-2xl font-semibold text-emerald-500">+<%= format_amount(total_income) %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500 mb-1">Expenses</p>
        <p class="text-2xl font-semibold text-rose-400">-<%= format_amount(total_expense) %></p>
      </div>
    </div>

    <!-- Imported Transactions Table -->
    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-6">
      <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
        <span class="font-medium text-slate-700">Imported Transactions</span>
        <% if @import.completed_at %>
          <span class="text-xs text-slate-400">Completed <%= time_ago_in_words(@import.completed_at) %> ago</span>
        <% end %>
      </div>

      <% if @imported_transactions.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Category</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <% @imported_transactions.each do |txn| %>
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">
                    <%= txn.date.strftime("%b %d, %Y") %>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-800">
                    <%= link_to txn.description, edit_transaction_path(txn), class: "hover:text-cyan-600" %>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-600">
                    <%= txn.category&.name || "â€”" %>
                  </td>
                  <td class="px-4 py-3 text-sm text-right whitespace-nowrap font-medium text-slate-700">
                    <%= txn.transaction_type == 'expense' ? '-' : '' %><%= format_amount(txn.amount) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-8 text-center text-slate-500">
          No transactions were imported from this file.
        </div>
      <% end %>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between bg-white rounded-xl border border-slate-200 p-4">
      <p class="text-sm text-slate-500">
        This import has been reviewed and completed.
      </p>
      <div class="flex items-center gap-3">
        <%= link_to transactions_path, class: "rounded-lg px-4 py-2 text-slate-600 hover:text-slate-800 font-medium transition text-sm" do %>
          View All Transactions
        <% end %>
        <%= button_to import_path(@import), method: :delete, class: "rounded-lg px-4 py-2 text-rose-500 hover:bg-rose-50 font-medium transition text-sm", form: { data: { turbo_confirm: "Delete this import? The imported transactions will remain." } } do %>
          Delete Import
        <% end %>
      </div>
    </div>
  <% end %>
</div>
