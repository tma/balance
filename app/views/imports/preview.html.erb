<% content_for :title, "Review Import" %>

<div>
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Review Transactions</h1>
      <p class="text-slate-600">Importing to <strong><%= @account.name %></strong></p>
    </div>
    <%= link_to "Back to Upload", new_import_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
  </div>

  <% if @extraction_successful && @transactions.any? %>
    <%= form_with url: imports_path, method: :post, class: "space-y-6" do |form| %>
      <%= form.hidden_field :account_id, value: @account.id %>

      <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
          <span class="font-medium text-slate-700">
            <%= @transactions.size %> transactions found
            <% duplicate_count = @transactions.count { |t| t[:is_duplicate] } %>
            <% if duplicate_count > 0 %>
              <span class="text-amber-600 text-sm ml-2">(<%= duplicate_count %> potential duplicates)</span>
            <% end %>
          </span>
          <label class="flex items-center text-sm text-slate-600">
            <input type="checkbox" id="select-all" checked class="rounded border-slate-300 text-cyan-500 focus:ring-cyan-500 mr-2">
            Select all non-duplicates
          </label>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-10">Import</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-28">Date</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-24">Type</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-44">Category</th>
                <th class="px-3 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-28">Amount</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
              <% @transactions.each_with_index do |txn, index| %>
                <tr class="<%= txn[:is_duplicate] ? 'bg-amber-50' : '' %> hover:bg-slate-50">
                  <td class="px-3 py-3">
                    <input type="checkbox" 
                           name="transactions[<%= index %>][selected]" 
                           value="1"
                           <%= txn[:is_duplicate] ? '' : 'checked' %>
                           class="transaction-checkbox rounded border-slate-300 text-cyan-500 focus:ring-cyan-500">
                    <%= hidden_field_tag "transactions[#{index}][date]", txn[:date] %>
                    <%= hidden_field_tag "transactions[#{index}][description]", txn[:description] %>
                    <%= hidden_field_tag "transactions[#{index}][amount]", txn[:amount] %>
                    <%= hidden_field_tag "transactions[#{index}][duplicate_hash]", txn[:duplicate_hash] %>
                  </td>
                  <td class="px-3 py-3 text-sm text-slate-900 whitespace-nowrap">
                    <%= txn[:date].strftime("%Y-%m-%d") %>
                  </td>
                  <td class="px-3 py-3 text-sm text-slate-900">
                    <div class="flex items-center">
                      <%= txn[:description] %>
                      <% if txn[:is_duplicate] %>
                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                          Duplicate
                        </span>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-3 py-3 text-sm whitespace-nowrap">
                    <select name="transactions[<%= index %>][transaction_type]" 
                            class="text-sm rounded border-slate-300 focus:border-cyan-500 focus:ring-cyan-500">
                      <option value="expense" <%= txn[:transaction_type] == 'expense' ? 'selected' : '' %>>Expense</option>
                      <option value="income" <%= txn[:transaction_type] == 'income' ? 'selected' : '' %>>Income</option>
                    </select>
                  </td>
                  <td class="px-3 py-3 text-sm whitespace-nowrap">
                    <select name="transactions[<%= index %>][category_id]" 
                            class="text-sm rounded border-slate-300 focus:border-cyan-500 focus:ring-cyan-500 w-full">
                      <optgroup label="Expense">
                        <% @expense_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                        <% end %>
                      </optgroup>
                      <optgroup label="Income">
                        <% @income_categories.each do |cat| %>
                          <option value="<%= cat.id %>" <%= txn[:category_id] == cat.id ? 'selected' : '' %>><%= cat.name %></option>
                        <% end %>
                      </optgroup>
                    </select>
                  </td>
                  <td class="px-3 py-3 text-sm text-slate-900 text-right whitespace-nowrap font-medium <%= txn[:transaction_type] == 'income' ? 'text-emerald-600' : 'text-slate-900' %>">
                    <%= number_with_delimiter(txn[:amount], delimiter: "'") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <%= form.submit "Import Selected", class: "rounded-lg px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-medium cursor-pointer transition" %>
        <%= link_to "Cancel", transactions_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
      </div>
    <% end %>

  <% elsif @extraction_successful && @transactions.empty? %>
    <div class="bg-amber-50 rounded-xl border border-amber-200 p-6 text-center">
      <svg class="mx-auto h-12 w-12 text-amber-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <h2 class="text-lg font-semibold text-amber-800 mb-2">No Transactions Found</h2>
      <p class="text-amber-700">The AI could not extract any transactions from your file. You can try uploading a different file or create transactions manually.</p>
      <div class="mt-4 space-x-4">
        <%= link_to "Try Again", new_import_path, class: "rounded-lg px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-medium transition" %>
        <%= link_to "Add Manually", new_transaction_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
      </div>
    </div>

  <% else %>
    <!-- Manual Fallback when Ollama fails -->
    <div class="bg-rose-50 rounded-xl border border-rose-200 p-6 mb-6">
      <div class="flex items-start">
        <svg class="h-6 w-6 text-rose-400 mr-3 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h2 class="text-lg font-semibold text-rose-800 mb-1">Automatic Extraction Failed</h2>
          <p class="text-rose-700 text-sm"><%= @extraction_error %></p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 p-6">
      <h2 class="font-semibold text-slate-700 mb-4">Manual Entry</h2>
      <p class="text-sm text-slate-600 mb-4">
        The automatic extraction couldn't process your file. You can review the extracted text below and add transactions manually.
      </p>
      
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">Extracted Text from File</label>
        <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 max-h-96 overflow-y-auto">
          <pre class="text-sm text-slate-600 whitespace-pre-wrap font-mono"><%= @raw_text.truncate(5000) %></pre>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <%= link_to "Add Transaction Manually", new_transaction_path(account_id: @account.id), class: "rounded-lg px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-medium transition" %>
        <%= link_to "Try Different File", new_import_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // Select all / deselect all functionality
  document.getElementById('select-all')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    checkboxes.forEach(cb => {
      // Only toggle non-duplicate rows
      const row = cb.closest('tr');
      if (!row.classList.contains('bg-amber-50')) {
        cb.checked = e.target.checked;
      }
    });
  });
</script>
