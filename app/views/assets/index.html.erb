<% content_for :title, "Assets & Liabilities" %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Records" %>
  <% end %>
<% end %>

<div class="w-full">
  <div class="flex justify-between items-center h-10 mb-6">
    <h1 class="<%= ui_title_class %>">Assets & Liabilities</h1>
    <div class="flex space-x-2">
      <%= link_to "New Group", new_asset_group_path, class: ui_btn_secondary_class %>
      <%= link_to "New Asset", new_asset_path, class: ui_btn_primary_class %>
    </div>
  </div>

  <% if @asset_groups.any? %>
    <div class="<%= ui_card_table_class %>">
      <table class="min-w-full" data-controller="sortable" data-sortable-url-value="<%= sort_asset_groups_path %>" data-sortable-type-value="group">
        <thead class="<%= ui_table_header_class %>">
          <tr>
            <th class="<%= ui_table_th_class %> w-8"></th>
            <th class="<%= ui_table_th_class %>">Name</th>
            <th class="<%= ui_table_th_class %>">Type</th>
            <th class="<%= ui_table_th_class %>">Currency</th>
            <th class="<%= ui_table_th_class %> text-right">Value</th>
            <th class="<%= ui_table_th_class %> text-right w-32"></th>
          </tr>
        </thead>
        <% @asset_groups.each do |group| %>
          <% active_assets = group.assets.active.includes(:asset_type, :broker_positions) %>
          <% archived_assets = group.assets.archived.includes(:asset_type, :broker_positions) %>
          <tbody data-sortable-target="item" data-id="<%= group.id %>" class="group-container">
            <tr class="<%= ui_table_group_header_class %> border-t border-b border-slate-200 dark:border-slate-600 cursor-move group-header">
              <td class="px-4 py-2 <%= ui_text_subtle_class %> text-xs leading-none">⋮⋮</td>
              <td colspan="3" class="px-4 py-2 text-sm font-medium <%= ui_table_group_text_class %>">
                <span class="inline-flex items-center">
                  <svg class="flex-shrink-0 mr-2" width="12" height="12"><rect width="12" height="12" fill="<%= group.color || '#94a3b8' %>"/></svg>
                  <span class="whitespace-nowrap"><%= group.name %></span>
                </span>
                <span class="<%= ui_text_muted_class %> ml-2"><%= active_assets.size %> asset<%= active_assets.size == 1 ? '' : 's' %></span>
              </td>
              <td class="px-4 py-2 text-right">
                <% net_value = group.assets.active.sum { |a| (a.asset_type.is_liability? ? -1 : 1) * (a.value_in_default_currency || 0) } %>
                <span class="text-sm font-bold <%= ui_text_class %>">
                  <%= format_currency(net_value) %>
                </span>
              </td>
              <td class="px-4 py-2 text-right">
                <%= link_to "Edit", edit_asset_group_path(group), class: "text-sm #{ui_link_class}" %>
              </td>
            </tr>
          </tbody>
          <tbody data-controller="sortable" data-sortable-url-value="<%= sort_assets_path %>" class="<%= ui_card_body_class %>">
            <%# Active assets - normal display %>
            <% active_assets.each do |asset| %>
              <tr class="<%= ui_table_row_class %> cursor-move" data-sortable-target="item" data-id="<%= asset.id %>">
                <td class="px-4 py-2 <%= ui_text_subtle_class %> pl-8 text-xs leading-none">⋮⋮</td>
                <td class="px-4 py-2 text-sm <%= ui_text_class %> font-medium">
                  <%= link_to asset.name, asset %>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-sm <%= ui_text_muted_class %>">
                  <%= asset.asset_type.name %>
                  <% if asset.asset_type.is_liability? %>
                    <span class="ml-1 <%= ui_badge_danger_class %>">Liability</span>
                  <% end %>
                  <% if asset.has_broker? %>
                    <span class="ml-1 <%= ui_badge_info_class %>">Broker</span>
                  <% end %>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-sm <%= ui_text_muted_class %>">
                  <%= asset.currency %>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-right <%= ui_text_class %>">
                  <%= asset.asset_type.is_liability? ? "-" : "" %><%= format_currency(asset.value) %>
                </td>
                <td class="px-4 py-2 whitespace-nowrap text-right text-sm">
                  <div class="flex items-center justify-end gap-2">
                    <%= link_to "Edit", edit_asset_path(asset), class: ui_link_class %>
                    <% if asset.has_broker? %>
                      <span class="<%= ui_text_subtle_class %> cursor-not-allowed" title="Cannot archive: linked to broker positions">Archive</span>
                    <% else %>
                      <%= button_to "Archive", archive_asset_path(asset), method: :patch, class: "text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300", form: { class: "inline" } %>
                    <% end %>
                    <%= button_to "Delete", asset, method: :delete, class: "text-rose-500 dark:text-rose-400 hover:text-rose-600 dark:hover:text-rose-300", form: { data: { turbo_confirm: "Are you sure? This will delete all valuation history." }, class: "inline" } %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>

          <%# Archived assets - collapsible section %>
          <% if archived_assets.any? %>
            <tbody data-controller="collapsible" class="<%= ui_card_body_class %>">
              <tr class="border-b border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700" data-action="click->collapsible#toggle">
                <td class="px-4 py-1 pl-8"></td>
                <td colspan="5" class="px-4 py-1 text-xs <%= ui_text_subtle_class %>">
                  <span data-collapsible-target="icon">▶</span>
                  <span class="ml-1">Archived</span>
                </td>
              </tr>
              <% archived_assets.each do |asset| %>
                <tr data-collapsible-target="content" class="hidden <%= ui_table_row_class %> bg-slate-50 dark:bg-slate-800/50">
                  <td class="px-4 py-2 <%= ui_text_subtle_class %> pl-8 text-xs leading-none"></td>
                  <td class="px-4 py-2 text-sm <%= ui_text_subtle_class %> font-medium">
                    <%= link_to asset.name, asset %>
                    <span class="ml-1 <%= ui_badge_class %>">Archived</span>
                  </td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm <%= ui_text_subtle_class %>">
                    <%= asset.asset_type.name %>
                    <% if asset.asset_type.is_liability? %>
                      <span class="ml-1 px-1.5 py-0.5 text-xs rounded bg-rose-50 dark:bg-rose-900/30 text-rose-300 dark:text-rose-400">Liability</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm <%= ui_text_subtle_class %>">
                    <%= asset.currency %>
                  </td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-right <%= ui_text_subtle_class %>">
                    <%= asset.asset_type.is_liability? ? "-" : "" %><%= format_currency(asset.value) %>
                  </td>
                  <td class="px-4 py-2 whitespace-nowrap text-right text-sm">
                    <div class="flex items-center justify-end gap-2">
                      <%= button_to "Unarchive", unarchive_asset_path(asset), method: :patch, class: ui_link_class, form: { class: "inline" } %>
                      <%= link_to "Edit", edit_asset_path(asset), class: ui_link_muted_class %>
                      <%= button_to "Delete", asset, method: :delete, class: "text-rose-400 dark:text-rose-500 hover:text-rose-600 dark:hover:text-rose-400", form: { data: { turbo_confirm: "Are you sure? This will permanently delete this asset and all its valuation history." }, class: "inline" } %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          <% end %>
        <% end %>
      </table>
    </div>
  <% else %>
    <div class="<%= ui_card_class %> <%= ui_empty_class %>">
      <p class="<%= ui_text_muted_class %> mb-4">No asset groups yet.</p>
      <p class="text-sm <%= ui_text_subtle_class %> mb-4">Create a group first, then add assets to it.</p>
      <%= link_to "Create a group", new_asset_group_path, class: ui_link_class %>
    </div>
  <% end %>
</div>
