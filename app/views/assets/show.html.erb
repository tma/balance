<% content_for :title, @asset.name %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Records" %>
    <%= ui_breadcrumb_item "Assets", assets_path %>
  <% end %>
<% end %>

<div class="w-full">
  <div class="flex justify-between items-center h-10 mb-6">
    <div>
      <h1 class="<%= ui_title_class %>">
        <%= @asset.name %>
        <% if @asset.archived? %>
          <span class="ml-2 <%= ui_badge_class %>">Archived</span>
        <% end %>
      </h1>
      <p class="<%= ui_text_muted_class %>">
        <%= @asset.asset_group.name %> ·
        <%= @asset.asset_type.name %> · <%= @asset.currency %>
        <% if @asset.asset_type.is_liability? %>
          <span class="ml-2 <%= ui_badge_danger_class %>">Liability</span>
        <% end %>
        <% if @asset.has_broker? %>
          <span class="ml-2 <%= ui_badge_info_class %>">Broker</span>
        <% end %>
      </p>
    </div>
    <div class="flex space-x-2">
      <% if @asset.archived? %>
        <%= button_to "Unarchive", unarchive_asset_path(@asset), method: :patch, class: "#{ui_btn_primary_class} cursor-pointer" %>
      <% end %>
      <%= link_to "Edit", edit_asset_path(@asset), class: ui_btn_secondary_class %>
    </div>
  </div>

  <div class="flex flex-col md:flex-row gap-4 mb-4">
    <div class="<%= ui_card_class %> p-4 <%= @asset.has_broker? ? 'md:flex-[2]' : 'flex-1' %>">
      <p class="text-sm <%= ui_text_muted_class %>">Current Value</p>
      <p class="text-2xl font-bold <%= ui_text_class %>">
        <%= @asset.asset_type.is_liability? ? "-" : "" %><%= format_currency(@asset.value) %>
      </p>
      <% if @asset.notes.present? %>
        <p class="mt-2 text-sm <%= ui_text_class %>"><%= @asset.notes %></p>
      <% end %>
    </div>

    <% if @asset.has_broker? %>
      <div class="<%= ui_alert_info_class %> md:flex-[3]">
        <p class="text-sm font-medium mb-2">Broker Positions</p>
        <div class="space-y-2">
          <% @asset.broker_positions.open.includes(:broker_connection, :position_valuations).each do |position| %>
            <div class="flex items-center justify-between text-sm">
              <div>
                <%= link_to admin_broker_connection_position_path(position.broker_connection, position), class: "font-semibold hover:underline text-cyan-800 dark:text-slate-100" do %>
                  <%= position.symbol %>
                <% end %>
                <span class="opacity-75">
                  · <%= link_to position.broker_connection.name, admin_broker_connection_path(position.broker_connection), class: "hover:underline text-cyan-800 dark:text-slate-100" %>
                </span>
              </div>
              <div class="text-right">
                <% if position.last_value.present? %>
                  <span class="font-medium"><%= format_currency(position.last_value, currency: position.currency) %></span>
                <% end %>
                <% last_valuation = position.position_valuations.order(date: :desc).first %>
                <% if last_valuation %>
                  <span class="opacity-75 text-xs ml-2">
                    as of <%= last_valuation.date.strftime("%b %d, %Y") %>
                  </span>
                <% elsif position.last_synced_at %>
                  <span class="opacity-75 text-xs ml-2">
                    synced <%= position.last_synced_at.strftime("%b %d") %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="<%= ui_card_table_class %>">
    <% if @valuations.any? %>
      <table class="min-w-full">
        <thead class="<%= ui_table_header_class %>">
          <tr>
            <th class="<%= ui_table_th_class %>">Date</th>
            <th class="<%= ui_table_th_class %> text-right">Value</th>
            <th class="<%= ui_table_th_class %> text-right w-24"></th>
          </tr>
        </thead>
        <tbody class="<%= ui_card_body_class %>">
          <% @valuations.each do |valuation| %>
            <tr class="<%= ui_table_row_class %>">
              <td class="<%= ui_table_td_class %> <%= ui_text_class %>">
                <%= valuation.date.strftime("%b %d, %Y") %>
              </td>
              <td class="<%= ui_table_td_class %> whitespace-nowrap text-right <%= ui_text_class %>">
                <%= @asset.asset_type.is_liability? ? "-" : "" %><%= format_currency(valuation.value) %>
              </td>
              <td class="<%= ui_table_td_class %> whitespace-nowrap text-right">
                <div class="flex items-center justify-end gap-2">
                  <%= link_to "Edit", edit_asset_valuation_path(@asset, valuation), class: ui_link_class %>
                  <%= button_to "Delete", asset_valuation_path(@asset, valuation), method: :delete, class: "text-rose-500 dark:text-rose-400 hover:text-rose-600 dark:hover:text-rose-300", form: { data: { turbo_confirm: "Are you sure?" }, class: "inline" } %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="p-8 text-center">
        <p class="<%= ui_text_muted_class %>">No valuation history yet.</p>
      </div>
    <% end %>
  </div>
</div>
