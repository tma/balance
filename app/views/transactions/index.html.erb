<% content_for :title, "Transactions" %>

<div class="w-full">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-800">Transactions</h1>
    <%= link_to "New Transaction", new_transaction_path, class: "rounded-lg px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-medium transition" %>
  </div>

  <!-- Month Navigation -->
  <% if @filter_mode == :month %>
    <div class="bg-white rounded-xl border border-slate-200 mb-4">
      <div class="flex items-center justify-between p-4">
        <% prev_month = @current_month - 1.month %>
        <% next_month = @current_month + 1.month %>
        
        <%= link_to transactions_path(month: prev_month.strftime("%Y-%m")), class: "p-2 hover:bg-slate-50 rounded-lg transition" do %>
          <span class="text-slate-500">&larr; <%= prev_month.strftime("%b %Y") %></span>
        <% end %>
        
        <div class="text-center">
          <h2 class="text-lg font-semibold text-slate-700"><%= @current_month.strftime("%B %Y") %></h2>
        </div>
        
        <% if next_month <= Date.current.end_of_month %>
          <%= link_to transactions_path(month: next_month.strftime("%Y-%m")), class: "p-2 hover:bg-slate-50 rounded-lg transition" do %>
            <span class="text-slate-500"><%= next_month.strftime("%b %Y") %> &rarr;</span>
          <% end %>
        <% else %>
          <span class="p-2 text-slate-200">&nbsp;</span>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Date Range Filter -->
  <div class="bg-white rounded-xl border border-slate-200 mb-4">
    <details class="group">
      <summary class="p-4 cursor-pointer flex items-center justify-between hover:bg-slate-50 rounded-xl transition">
        <span class="font-medium text-slate-600">
          <% if @filter_mode == :range %>
            Custom Range: <%= @start_date.strftime("%b %d, %Y") %> - <%= @end_date.strftime("%b %d, %Y") %>
          <% else %>
            Filter by Date Range
          <% end %>
        </span>
        <span class="text-slate-400 group-open:rotate-180 transition-transform">&#9660;</span>
      </summary>
      <div class="p-4 border-t border-slate-200">
        <%= form_with url: transactions_path, method: :get, class: "flex flex-wrap gap-4 items-end" do |f| %>
          <div>
            <%= f.label :start_date, "Start Date", class: "block text-sm font-medium text-slate-700" %>
            <%= f.date_field :start_date, value: @start_date || @current_month, class: "mt-1 rounded-lg border-slate-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 border px-3 py-2" %>
          </div>
          <div>
            <%= f.label :end_date, "End Date", class: "block text-sm font-medium text-slate-700" %>
            <%= f.date_field :end_date, value: @end_date || (@current_month&.end_of_month || Date.current), class: "mt-1 rounded-lg border-slate-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 border px-3 py-2" %>
          </div>
          <div class="flex gap-2">
            <%= f.submit "Apply", class: "rounded-lg px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-medium cursor-pointer transition" %>
            <% if @filter_mode == :range %>
              <%= link_to "Clear", transactions_path, class: "rounded-lg px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition" %>
            <% end %>
          </div>
        <% end %>
      </div>
    </details>
  </div>

  <!-- Summary -->
  <% if @transactions.any? %>
    <% net = @total_income - @total_expenses %>
    <% saving_rate = @total_income > 0 ? (net / @total_income * 100).round(1) : 0 %>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500">Income</p>
        <p class="text-xl font-semibold text-emerald-500">+<%= number_to_currency(@total_income) %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500">Expenses</p>
        <p class="text-xl font-semibold text-rose-400">-<%= number_to_currency(@total_expenses) %></p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500">Net</p>
        <p class="text-xl font-semibold <%= net >= 0 ? 'text-emerald-500' : 'text-rose-400' %>">
          <%= net >= 0 ? '+' : '' %><%= number_to_currency(net) %>
        </p>
      </div>
      <div class="bg-white rounded-xl border border-slate-200 p-4">
        <p class="text-sm text-slate-500">Saving Rate</p>
        <p class="text-xl font-semibold <%= saving_rate >= 0 ? 'text-cyan-500' : 'text-rose-400' %>">
          <%= saving_rate %>%
        </p>
      </div>
    </div>
  <% end %>

  <!-- Transactions Table -->
  <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
    <% if @transactions.any? %>
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Category</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Account</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-24"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-100">
          <% @transactions.order(date: :desc, created_at: :desc).each do |transaction| %>
            <tr class="hover:bg-slate-50 transition">
              <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-600">
                <%= transaction.date.strftime("%b %d") %>
              </td>
              <td class="px-4 py-2 text-sm text-slate-700">
                <%= transaction.description.presence || "-" %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-600">
                <%= transaction.category.name.titleize %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-500">
                <%= transaction.account.name %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-right font-medium <%= transaction.income? ? 'text-emerald-500' : 'text-rose-400' %>">
                <%= transaction.income? ? '+' : '-' %><%= number_to_currency(transaction.amount) %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-right text-sm space-x-2">
                <%= link_to "Edit", edit_transaction_path(transaction), class: "text-cyan-600 hover:text-cyan-700" %>
                <%= button_to "Delete", transaction, method: :delete, class: "text-rose-500 hover:text-rose-600", form: { data: { turbo_confirm: "Are you sure?" }, class: "inline" } %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="p-8 text-center">
        <p class="text-slate-500 mb-4">No transactions for this period.</p>
        <%= link_to "Add a transaction", new_transaction_path, class: "text-cyan-600 hover:underline" %>
      </div>
    <% end %>
  </div>
</div>
