<% content_for :title, "Transactions" %>

<div class="w-full">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Transactions</h1>
    <%= link_to "New Transaction", new_transaction_path, class: "rounded-md px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium" %>
  </div>

  <!-- Month Navigation -->
  <% if @filter_mode == :month %>
    <div class="bg-white rounded-lg shadow mb-4">
      <div class="flex items-center justify-between p-4">
        <% prev_month = @current_month - 1.month %>
        <% next_month = @current_month + 1.month %>
        
        <%= link_to transactions_path(month: prev_month.strftime("%Y-%m")), class: "p-2 hover:bg-gray-100 rounded-lg" do %>
          <span class="text-gray-600">&larr; <%= prev_month.strftime("%b %Y") %></span>
        <% end %>
        
        <div class="text-center">
          <h2 class="text-lg font-semibold"><%= @current_month.strftime("%B %Y") %></h2>
        </div>
        
        <% if next_month <= Date.current.end_of_month %>
          <%= link_to transactions_path(month: next_month.strftime("%Y-%m")), class: "p-2 hover:bg-gray-100 rounded-lg" do %>
            <span class="text-gray-600"><%= next_month.strftime("%b %Y") %> &rarr;</span>
          <% end %>
        <% else %>
          <span class="p-2 text-gray-300">&nbsp;</span>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Date Range Filter -->
  <div class="bg-white rounded-lg shadow mb-4">
    <details class="group">
      <summary class="p-4 cursor-pointer flex items-center justify-between hover:bg-gray-50">
        <span class="font-medium text-gray-700">
          <% if @filter_mode == :range %>
            Custom Range: <%= @start_date.strftime("%b %d, %Y") %> - <%= @end_date.strftime("%b %d, %Y") %>
          <% else %>
            Filter by Date Range
          <% end %>
        </span>
        <span class="text-gray-400 group-open:rotate-180 transition-transform">&#9660;</span>
      </summary>
      <div class="p-4 border-t">
        <%= form_with url: transactions_path, method: :get, class: "flex flex-wrap gap-4 items-end" do |f| %>
          <div>
            <%= f.label :start_date, "Start Date", class: "block text-sm font-medium text-gray-700" %>
            <%= f.date_field :start_date, value: @start_date || @current_month, class: "mt-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border px-3 py-2" %>
          </div>
          <div>
            <%= f.label :end_date, "End Date", class: "block text-sm font-medium text-gray-700" %>
            <%= f.date_field :end_date, value: @end_date || (@current_month&.end_of_month || Date.current), class: "mt-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border px-3 py-2" %>
          </div>
          <div class="flex gap-2">
            <%= f.submit "Apply", class: "rounded-md px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium cursor-pointer" %>
            <% if @filter_mode == :range %>
              <%= link_to "Clear", transactions_path, class: "rounded-md px-4 py-2 bg-gray-100 hover:bg-gray-50 font-medium" %>
            <% end %>
          </div>
        <% end %>
      </div>
    </details>
  </div>

  <!-- Summary -->
  <% if @transactions.any? %>
    <div class="grid grid-cols-3 gap-4 mb-4">
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-500">Income</p>
        <p class="text-xl font-semibold text-green-600">+<%= number_to_currency(@total_income) %></p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-500">Expenses</p>
        <p class="text-xl font-semibold text-red-600">-<%= number_to_currency(@total_expenses) %></p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-500">Net</p>
        <% net = @total_income - @total_expenses %>
        <p class="text-xl font-semibold <%= net >= 0 ? 'text-green-600' : 'text-red-600' %>">
          <%= net >= 0 ? '+' : '' %><%= number_to_currency(net) %>
        </p>
      </div>
    </div>
  <% end %>

  <!-- Transactions grouped by date -->
  <div class="space-y-4">
    <% if @transactions_by_date.any? %>
      <% @transactions_by_date.keys.sort.reverse.each do |date| %>
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <div class="bg-slate-50 px-4 py-2 border-b">
            <div class="flex justify-between items-center">
              <h3 class="font-medium text-gray-700"><%= date.strftime("%A, %B %d, %Y") %></h3>
              <% day_transactions = @transactions_by_date[date] %>
              <% day_income = day_transactions.select(&:income?).sum(&:amount) %>
              <% day_expenses = day_transactions.select(&:expense?).sum(&:amount) %>
              <div class="text-sm space-x-3">
                <% if day_income > 0 %>
                  <span class="text-green-600">+<%= number_to_currency(day_income) %></span>
                <% end %>
                <% if day_expenses > 0 %>
                  <span class="text-red-600">-<%= number_to_currency(day_expenses) %></span>
                <% end %>
              </div>
            </div>
          </div>
          <div class="divide-y">
            <% @transactions_by_date[date].each do |transaction| %>
              <div class="p-4 hover:bg-gray-50 flex justify-between items-center">
                <div class="flex-1">
                  <div class="flex items-center space-x-3">
                    <div>
                      <p class="font-medium text-gray-900"><%= transaction.description.presence || transaction.category.name.titleize %></p>
                      <p class="text-sm text-gray-500">
                        <%= transaction.category.name.titleize %> &middot; <%= transaction.account.name %>
                      </p>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-semibold text-lg <%= transaction.income? ? 'text-green-600' : 'text-red-600' %>">
                    <%= transaction.income? ? '+' : '-' %><%= number_to_currency(transaction.amount) %>
                  </p>
                  <div class="flex space-x-2 text-sm justify-end mt-1">
                    <%= link_to "Edit", edit_transaction_path(transaction), class: "text-blue-600 hover:underline" %>
                    <%= button_to "Delete", transaction, method: :delete, class: "text-red-600 hover:underline", form: { data: { turbo_confirm: "Are you sure?" } } %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="bg-white rounded-lg shadow p-8 text-center">
        <p class="text-gray-500 mb-4">No transactions for this period.</p>
        <%= link_to "Add a transaction", new_transaction_path, class: "text-blue-600 hover:underline" %>
      </div>
    <% end %>
  </div>
</div>
