<% content_for :title, "Transactions" %>

<% content_for :breadcrumbs do %>
  <%= ui_breadcrumbs do %>
    <%= ui_breadcrumb_first "Records" %>
  <% end %>
<% end %>

<div class="w-full">
  <div class="flex justify-between items-center h-10 mb-6">
    <h1 class="<%= ui_title_class %>">Transactions</h1>
    <div class="flex items-center space-x-2">
      <%= link_to "Import", new_import_path, class: ui_btn_secondary_class %>
      <%= link_to "New", new_transaction_path, class: ui_btn_primary_class %>
    </div>
  </div>

  <% if @filter_mode == :search %>
    <!-- Search Mode: Full-width search with results -->
    <div class="mb-4">
      <%= form_with url: transactions_path, method: :get, class: "w-full" do |f| %>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 <%= ui_text_subtle_class %>" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <%= f.text_field :search,
                value: @search_query,
                placeholder: "Search transactions by description...",
                class: "w-full pl-10 pr-10 py-2 #{ui_input_class}",
                autofocus: true %>
          <%= link_to transactions_path, class: "absolute inset-y-0 right-0 pr-3 flex items-center #{ui_text_subtle_class} hover:text-slate-600 dark:hover:text-slate-300" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="mb-4">
      <p class="text-sm <%= ui_text_muted_class %>">
        Found <span class="font-medium"><%= @transactions.size %></span> transaction<%= @transactions.size == 1 ? '' : 's' %> matching "<span class="font-medium"><%= @search_query %></span>"
      </p>
    </div>
  <% else %>
    <!-- Month Navigation & Date Filter -->
    <div class="<%= ui_card_class %> mb-4 px-4 py-2">
      <div class="flex items-center justify-between">
        <% if @filter_mode == :month %>
          <% prev_month = @current_month - 1.month %>
          <%
            prev_params = { month: prev_month.strftime("%Y-%m") }
            prev_params[:account_id] = params[:account_id] if params[:account_id].present?
            prev_params[:category_id] = params[:category_id] if params[:category_id].present?
          %>
          <%= link_to transactions_path(prev_params), class: "p-1 hover:bg-slate-50 dark:hover:bg-slate-700 transition #{ui_text_muted_class} text-sm" do %>
            &larr; <%= prev_month.strftime("%b") %>
          <% end %>
        <% else %>
          <span></span>
        <% end %>

        <div class="flex items-center gap-4">
          <% if @filter_mode == :month %>
            <span class="font-semibold <%= ui_text_class %>"><%= @current_month.strftime("%B %Y") %></span>
          <% elsif @filter_mode == :range %>
            <span class="text-sm <%= ui_text_muted_class %>"><%= @start_date.strftime("%b %d") %> - <%= @end_date.strftime("%b %d, %Y") %></span>
            <%= link_to "Clear", transactions_path, class: ui_link_class + " text-sm" %>
          <% end %>

          <details class="group relative">
            <summary class="cursor-pointer text-sm <%= ui_text_subtle_class %> hover:text-slate-600 dark:hover:text-slate-300 list-none flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span class="group-open:rotate-180 transition-transform text-xs">&#9660;</span>
            </summary>
            <div class="absolute right-0 top-full mt-2 <%= ui_card_class %> shadow-lg p-3 z-10">
              <%= form_with url: transactions_path, method: :get, class: "flex items-center gap-2" do |f| %>
                <%= f.hidden_field :account_id, value: params[:account_id] if params[:account_id].present? %>
                <%= f.hidden_field :category_id, value: params[:category_id] if params[:category_id].present? %>
                <%= f.date_field :start_date, value: @start_date || @current_month, class: "#{ui_input_sm_class} w-32" %>
                <span class="<%= ui_text_subtle_class %>">-</span>
                <%= f.date_field :end_date, value: @end_date || (@current_month&.end_of_month || Date.current), class: "#{ui_input_sm_class} w-32" %>
                <%= f.submit "Go", class: "#{ui_btn_primary_class} #{ui_btn_sm_class} cursor-pointer" %>
              <% end %>
            </div>
          </details>
        </div>

        <% if @filter_mode == :month %>
          <% next_month = @current_month + 1.month %>
          <% if next_month <= Date.current.end_of_month %>
            <%
              next_params = { month: next_month.strftime("%Y-%m") }
              next_params[:account_id] = params[:account_id] if params[:account_id].present?
              next_params[:category_id] = params[:category_id] if params[:category_id].present?
            %>
            <%= link_to transactions_path(next_params), class: "p-1 hover:bg-slate-50 dark:hover:bg-slate-700 transition #{ui_text_muted_class} text-sm" do %>
              <%= next_month.strftime("%b") %> &rarr;
            <% end %>
          <% else %>
            <span class="p-1 text-transparent text-sm">Dec &rarr;</span>
          <% end %>
        <% else %>
          <span></span>
        <% end %>
      </div>
    </div>

    <!-- Filters & Search -->
    <div class="flex flex-col md:flex-row md:items-center gap-3 mb-4">
      <%= form_with url: transactions_path, method: :get, class: "flex flex-wrap items-center gap-2 flex-1", data: { controller: "auto-submit" } do |f| %>
        <% if @filter_mode == :month %>
          <%= f.hidden_field :month, value: @current_month.strftime("%Y-%m") %>
        <% else %>
          <%= f.hidden_field :start_date, value: @start_date %>
          <%= f.hidden_field :end_date, value: @end_date %>
        <% end %>

        <%= f.select :account_id,
              grouped_account_options(@accounts, params[:account_id]),
              { include_blank: "Accounts" },
              class: ui_input_sm_class,
              onchange: "this.form.requestSubmit()" %>

        <%= f.select :category_id,
              grouped_options_for_select(
                [
                  ["Income", @categories.select { |c| c.category_type == "income" }.map { |c| [c.name, c.id] }],
                  ["Expense", @categories.select { |c| c.category_type == "expense" }.map { |c| [c.name, c.id] }]
                ],
                params[:category_id]
              ),
              { include_blank: "Categories" },
              class: ui_input_sm_class,
              onchange: "this.form.requestSubmit()" %>

        <% if @selected_account || @selected_category %>
          <%
            clear_params = {}
            clear_params[:month] = @current_month.strftime("%Y-%m") if @filter_mode == :month
            clear_params[:start_date] = @start_date if @filter_mode == :range
            clear_params[:end_date] = @end_date if @filter_mode == :range
          %>
          <%= link_to "Clear", transactions_path(clear_params), class: ui_link_class + " text-sm" %>
        <% end %>
      <% end %>

      <%= form_with url: transactions_path, method: :get, class: "flex-1 md:max-w-xs" do |f| %>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 <%= ui_text_subtle_class %>" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <%= f.text_field :search,
                placeholder: "Search descriptions...",
                class: "w-full pl-8 pr-3 py-1.5 #{ui_input_sm_class}" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Summary -->
  <% if @transactions.any? %>
    <% net = @total_income - @total_expenses %>
    <% saving_rate = @total_income > 0 ? (net / @total_income * 100).round(1) : 0 %>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %>">Income</p>
        <p class="text-xl font-semibold <%= ui_positive_class %>">+<%= format_currency(@total_income) %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %>">Expenses</p>
        <p class="text-xl font-semibold <%= ui_negative_class %>">-<%= format_currency(@total_expenses) %></p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %>">Net</p>
        <p class="text-xl font-semibold <%= net >= 0 ? ui_positive_class : ui_negative_class %>">
          <%= net >= 0 ? '+' : '' %><%= format_currency(net) %>
        </p>
      </div>
      <div class="<%= ui_card_class %> p-4">
        <p class="text-sm <%= ui_text_muted_class %>">Saving Rate</p>
        <p class="text-xl font-semibold <%= saving_rate >= 0 ? 'text-cyan-500 dark:text-cyan-400' : ui_negative_class %>">
          <%= saving_rate %>%
        </p>
      </div>
    </div>
  <% end %>

  <!-- Transactions Table -->
  <div class="<%= ui_card_table_class %>">
    <% if @transactions.any? %>
      <table class="min-w-full">
        <thead class="<%= ui_table_header_class %> border-b border-slate-200 dark:border-slate-700">
          <tr>
            <th class="<%= ui_table_th_class %>">Date</th>
            <th class="<%= ui_table_th_class %>">Description</th>
            <th class="<%= ui_table_th_class %>">Category</th>
            <th class="<%= ui_table_th_class %>">Account</th>
            <th class="<%= ui_table_th_class %> text-right" colspan="2">Amount</th>
            <th class="<%= ui_table_th_class %> text-right w-24"></th>
          </tr>
        </thead>
        <tbody>
          <% @transactions.order(date: :desc, created_at: :desc).group_by(&:date).each do |date, day_transactions| %>
            <tr class="<%= ui_table_group_header_class %> border-t-[6px] border-slate-100 dark:border-slate-900">
              <td colspan="7" class="px-4 py-1.5 text-xs font-medium <%= ui_table_group_text_class %>">
                <%= date.strftime("%A, %B %d") %>
                <span class="<%= ui_text_muted_class %> ml-2"><%= day_transactions.size %> transaction<%= day_transactions.size == 1 ? '' : 's' %></span>
              </td>
            </tr>
            <% day_transactions.each do |transaction| %>
              <tr class="<%= ui_table_row_class %> last:border-b-0">
                <td class="<%= ui_table_td_class %> whitespace-nowrap text-sm <%= ui_text_subtle_class %>">
                  <%= transaction.date.strftime("%b %d") %>
                </td>
                <td class="<%= ui_table_td_class %> text-sm <%= ui_text_class %>">
                  <%= transaction.description.presence || "-" %>
                </td>
                <td class="<%= ui_table_td_class %> whitespace-nowrap text-sm <%= ui_text_muted_class %>">
                  <%= transaction.category.name %>
                </td>
                <td class="<%= ui_table_td_class %> whitespace-nowrap text-sm <%= ui_text_muted_class %>">
                  <%= transaction.account.name %> <span class="px-1.5 py-0.5 text-xs bg-sky-50 dark:bg-sky-900/50 text-sky-600 dark:text-sky-300"><%= transaction.account.currency %></span>
                </td>
                <td class="<%= ui_table_td_class %> whitespace-nowrap text-xs text-right pr-1 <%= ui_text_subtle_class %>">
                  <% if transaction.currency != transaction.default_currency %>
                    <%= transaction.currency %> <%= format_amount(transaction.amount) %>
                  <% end %>
                </td>
                <td class="<%= ui_table_td_class %> whitespace-nowrap text-sm text-right pl-1 font-medium <%= transaction.income? ? ui_positive_class : ui_negative_class %>">
                  <%= transaction.income? ? '+' : '-' %><%= format_currency(transaction.amount_in_default_currency) %>
                </td>
                <td class="<%= ui_table_td_class %> whitespace-nowrap text-right text-sm">
                  <div class="flex items-center justify-end gap-2">
                    <%= link_to "Edit", edit_transaction_path(transaction), class: ui_link_class %>
                    <%= button_to "Delete", transaction, method: :delete, params: request.query_parameters.slice("month", "start_date", "end_date", "account_id", "category_id", "search"), class: "text-rose-500 dark:text-rose-400 hover:text-rose-600 dark:hover:text-rose-300", form: { data: { turbo_confirm: "Are you sure?" } } %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="<%= ui_empty_class %>">
        <p class="<%= ui_text_muted_class %> mb-4">No transactions for this period.</p>
        <%= link_to "Add a transaction", new_transaction_path, class: ui_link_class %>
      </div>
    <% end %>
  </div>
</div>
